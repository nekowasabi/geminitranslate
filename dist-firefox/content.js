(()=>{"use strict";class e{constructor(){this.originalTextMap=new WeakMap,this.IGNORED_TAGS=["SCRIPT","STYLE","NOSCRIPT","IFRAME","SVG","CANVAS","CODE","PRE"],this.extractedTextsSet=new Set}extractTextNodes(){const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:e=>{const t=e.parentElement;return t?this.IGNORED_TAGS.includes(t.tagName)||t.closest('svg, [contenteditable="true"], [data-no-translate], .no-translate')?NodeFilter.FILTER_REJECT:e.textContent?.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT:NodeFilter.FILTER_REJECT}}),t=[];let n,o=0;for(this.extractedTextsSet.clear();n=e.nextNode();){const e=(n.textContent||"").trim();this.saveOriginalText(n),t.push({node:n,text:e,index:o}),this.extractedTextsSet.add(e),o++}return t}applyTranslations(e,t){e.forEach((e,n)=>{t[n]&&t[n].trim()&&(e.node.textContent=t[n])})}reset(){const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT);let t;for(;t=e.nextNode();){const e=this.originalTextMap.get(t);void 0!==e&&(t.textContent=e)}}saveOriginalText(e){this.originalTextMap.has(e)||this.originalTextMap.set(e,e.textContent||"")}detectViewportNodes(e){const t=[],n=[];return e.forEach(e=>{const o=document.createRange();o.selectNodeContents(e.node);const s=o.getBoundingClientRect();if(0===s.width&&0===s.height){const o=e.node.parentElement;if(o){const s=o.getBoundingClientRect();s.top<window.innerHeight&&s.bottom>0&&s.left<window.innerWidth&&s.right>0?t.push(e):n.push(e)}else n.push(e);return}s.top<window.innerHeight&&s.bottom>0&&s.left<window.innerWidth&&s.right>0?t.push(e):n.push(e)}),{viewport:t,outOfViewport:n}}}const t=new class{constructor(){this.api="undefined"!=typeof chrome&&chrome.runtime?chrome:browser}handleRuntimeError(e,t,n){this.api.runtime.lastError?t(new Error(this.api.runtime.lastError.message)):e(n)}get isChrome(){return"undefined"!=typeof chrome&&!!chrome.runtime}get isFirefox(){return!this.isChrome&&"undefined"!=typeof browser&&!!browser.runtime}get manifestVersion(){return this.api.runtime.getManifest().manifest_version}get storage(){return{get:e=>new Promise((t,n)=>{this.api.storage.local.get(e,e=>{this.handleRuntimeError(t,n,e)})}),set:e=>new Promise((t,n)=>{this.api.storage.local.set(e,()=>{this.handleRuntimeError(t,n,void 0)})}),remove:e=>new Promise((t,n)=>{this.api.storage.local.remove(e,()=>{this.handleRuntimeError(t,n,void 0)})})}}get runtime(){return{sendMessage:e=>new Promise(t=>{this.api.runtime.sendMessage(e,e=>{t(e)})}),onMessage:this.api.runtime.onMessage,getManifest:()=>this.api.runtime.getManifest(),openOptionsPage:()=>this.api.runtime.openOptionsPage()}}get tabs(){return{query:e=>new Promise(t=>{this.api.tabs.query(e,t)}),sendMessage:(e,t)=>new Promise(n=>{this.api.tabs.sendMessage(e,t,e=>{n(e)})})}}get commands(){return{onCommand:this.api.commands.onCommand}}};class n{constructor(){this.listeners=new Map}async send(e){const n={...e,timestamp:e.timestamp||Date.now()};return t.runtime.sendMessage(n)}async sendToTab(e,n){const o={...n,timestamp:n.timestamp||Date.now()};return t.tabs.sendMessage(e,o)}listen(e,n){const o=(t,o,s)=>(!n||t.type===n)&&(e(t,o,s)||!1);this.listeners.set(e,o),t.runtime.onMessage.addListener(o)}unlisten(e){const n=this.listeners.get(e);n&&(t.runtime.onMessage.removeListener(n),this.listeners.delete(e))}}var o;function s(e){return`${function(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:${String(e.getSeconds()).padStart(2,"0")}`}()} [${e}]`}new n,function(e){e.TRANSLATE_PAGE="translate",e.TRANSLATE_SELECTION="translateSelection",e.TRANSLATE_CLIPBOARD="translateClipboard",e.REQUEST_TRANSLATION="requestTranslation",e.RESET="reset",e.TRANSLATION_STARTED="translationStarted",e.TRANSLATION_PROGRESS="translationProgress",e.TRANSLATION_COMPLETED="translationCompleted",e.TRANSLATION_ERROR="translationError",e.SELECTION_TRANSLATED="selectionTranslated",e.BATCH_COMPLETED="batchCompleted",e.SETTINGS_CHANGED="settingsChanged",e.API_KEY_UPDATED="apiKeyUpdated",e.RELOAD_CONFIG="reloadConfig",e.TEST_CONNECTION="testConnection"}(o||(o={}));const a={log(e,...t){},warn(e,...t){const n=s("WARN");console.warn(`${n} ${e}`,...t)},error(e,...t){const n=s("ERROR");console.error(`${n} ${e}`,...t)}};new Map([{code:"en",name:"English",nameEn:"English"},{code:"ja",name:"日本語",nameEn:"Japanese"},{code:"zh",name:"中文",nameEn:"Chinese (Simplified)"},{code:"zh-TW",name:"中文 (繁體)",nameEn:"Chinese (Traditional)"},{code:"ko",name:"한국어",nameEn:"Korean"},{code:"es",name:"Español",nameEn:"Spanish"},{code:"fr",name:"Français",nameEn:"French"},{code:"de",name:"Deutsch",nameEn:"German"},{code:"it",name:"Italiano",nameEn:"Italian"},{code:"pt",name:"Português",nameEn:"Portuguese"},{code:"ru",name:"Русский",nameEn:"Russian"},{code:"ar",name:"العربية",nameEn:"Arabic"},{code:"hi",name:"हिन्दी",nameEn:"Hindi"},{code:"th",name:"ไทย",nameEn:"Thai"},{code:"vi",name:"Tiếng Việt",nameEn:"Vietnamese"},{code:"id",name:"Bahasa Indonesia",nameEn:"Indonesian"},{code:"tr",name:"Türkçe",nameEn:"Turkish"},{code:"pl",name:"Polski",nameEn:"Polish"},{code:"nl",name:"Nederlands",nameEn:"Dutch"},{code:"sv",name:"Svenska",nameEn:"Swedish"}].map(e=>[e.code,e]));const i={openRouterApiKey:void 0,targetLanguage:"ja",fontSize:16,lineHeight:1.5,darkMode:!1,openRouterModel:"",schemaVersion:3,selectionFontSize:14},r=class{async get(e){try{console.log("[StorageManager] get() called with keys:",e);const n=e?await t.storage.get(e):await t.storage.get([]);console.log("[StorageManager] Raw data from BrowserAdapter:",n),console.log("[StorageManager] Data keys:",Object.keys(n)),console.log("[StorageManager] openRouterApiKey:",n.openRouterApiKey),console.log("[StorageManager] openRouterModel:",n.openRouterModel),n.lineHeight&&n.lineHeight>2&&(n.lineHeight=1.5,await this.set({lineHeight:1.5}));const o={...i,...n};return console.log("[StorageManager] Merged result:",o),console.log("[StorageManager] Result openRouterApiKey:",o.openRouterApiKey),console.log("[StorageManager] Result openRouterModel:",o.openRouterModel),o}catch(e){return console.error("[StorageManager] get error:",e),console.error("[StorageManager] Returning DEFAULT_STORAGE due to error"),i}}async set(e){try{await t.storage.set(e)}catch(e){throw console.error("StorageManager.set error:",e),e}}async remove(e){try{await t.storage.remove(e)}catch(e){throw console.error("StorageManager.remove error:",e),e}}async clear(){try{const e="undefined"!=typeof chrome?chrome:browser;return new Promise(t=>{e.storage.local.clear(()=>{t()})})}catch(e){throw console.error("StorageManager.clear error:",e),e}}async getApiKey(){try{return(await this.get(["openRouterApiKey"])).openRouterApiKey||null}catch(e){return console.error("StorageManager.getApiKey error:",e),null}}async setApiKey(e){try{await this.set({openRouterApiKey:e})}catch(e){throw console.error("StorageManager.setApiKey error:",e),e}}async getTargetLanguage(){try{return(await this.get(["targetLanguage"])).targetLanguage||i.targetLanguage}catch(e){return console.error("StorageManager.getTargetLanguage error:",e),i.targetLanguage}}async setTargetLanguage(e){try{await this.set({targetLanguage:e})}catch(e){throw console.error("StorageManager.setTargetLanguage error:",e),e}}};class l{constructor(){this.badgeElement=null,this.clickHandler=null,this.floatingResultElement=null,this.storageManager=new r}show(e,t){this.hide(),this.clickHandler=t,this.badgeElement=this.createBadgeElement(),this.badgeElement.addEventListener("click",this.handleClick.bind(this)),document.body.appendChild(this.badgeElement),this.positionElement(e),a.log("IconBadge shown at",e)}hide(){this.badgeElement&&this.badgeElement.parentNode&&(this.badgeElement.parentNode.removeChild(this.badgeElement),this.badgeElement=null,this.clickHandler=null,a.log("IconBadge hidden"))}async showTranslationResult(e,t,n,o){this.hide(),this.hideFloatingResult(),this.floatingResultElement=await this.createFloatingResultElement(e,t,n),document.body.appendChild(this.floatingResultElement),this.positionFloatingResult(o),a.log("FloatingUI translation result shown at",o)}hideFloatingResult(){this.floatingResultElement&&this.floatingResultElement.parentNode&&(this.floatingResultElement.parentNode.removeChild(this.floatingResultElement),this.floatingResultElement=null,a.log("FloatingUI translation result hidden"))}createBadgeElement(){const e=document.createElement("div");e.className="icon-badge";const t=window.matchMedia("(prefers-color-scheme: dark)").matches;return Object.assign(e.style,{position:"fixed",zIndex:"10002",width:"32px",height:"32px",borderRadius:"50%",backgroundColor:t?"#6366F1":"#4F46E5",color:"white",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",transition:"all 0.2s ease",fontSize:"16px",fontWeight:"bold",userSelect:"none"}),e.textContent="T",e.addEventListener("mouseenter",()=>{e.style.transform="scale(1.1)",e.style.boxShadow="0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)"}),e.addEventListener("mouseleave",()=>{e.style.transform="scale(1)",e.style.boxShadow="0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)"}),e}positionElement(e){if(!this.badgeElement)return;const t=this.badgeElement.getBoundingClientRect(),n=t.width||32,o=t.height||32,s=window.innerWidth-n-8,a=(window.innerHeight-o)/2;this.badgeElement.style.left=`${s}px`,this.badgeElement.style.top=`${a}px`}handleClick(){a.log("IconBadge clicked"),this.clickHandler&&this.clickHandler()}async createFloatingResultElement(e,t,n){const o=document.createElement("div");o.className="gemini-translate-floating-result";const s=(await this.storageManager.get(["selectionFontSize"])).selectionFontSize??14;o.style.setProperty("--selection-font-size",`${s}px`);const i=document.createElement("button");i.className="close-button",i.textContent="×",i.addEventListener("click",()=>{this.hideFloatingResult()});const r=document.createElement("div");r.className="header";const l=document.createElement("h3");l.textContent="翻訳結果";const c=document.createElement("span");c.className="target-language",c.textContent=n,r.appendChild(l),r.appendChild(c);const d=document.createElement("div");d.className="content";const h=document.createElement("div");h.className="text-section";const g=document.createElement("div");g.className="text-label",g.textContent="翻訳結果";const p=document.createElement("div");p.className="translated-text",p.textContent=t,h.appendChild(g),h.appendChild(p),d.appendChild(h);const u=document.createElement("div");u.className="actions";const m=document.createElement("button");return m.className="copy-button",m.textContent="コピー",m.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(t),m.textContent="コピーしました！",setTimeout(()=>{m.textContent="コピー"},2e3)}catch(e){a.error("Failed to copy to clipboard:",e),m.textContent="コピー失敗",setTimeout(()=>{m.textContent="コピー"},2e3)}}),u.appendChild(m),o.appendChild(i),o.appendChild(r),o.appendChild(d),o.appendChild(u),o}positionFloatingResult(e){this.floatingResultElement&&(this.floatingResultElement.style.position="fixed",this.floatingResultElement.style.right="0",this.floatingResultElement.style.top="0",this.floatingResultElement.style.bottom="0",this.floatingResultElement.style.width="400px",this.floatingResultElement.style.overflowY="auto",this.floatingResultElement.style.left="auto")}}class c{constructor(){this.enabled=!1,this.mouseUpHandler=null,this.isTranslating=!1,this.selectionFontSizeCache=null,this.messageBus=new n,this.iconBadge=new l,this.storageManager=new r,this.setupStorageListener()}setupStorageListener(){"undefined"!=typeof browser&&browser.storage&&browser.storage.onChanged&&browser.storage.onChanged.addListener((e,t)=>{"local"===t&&e.selectionFontSize&&(this.selectionFontSizeCache=null,a.log("Selection font size cache invalidated"))})}async getSelectionFontSize(){if(null!==this.selectionFontSizeCache)return this.selectionFontSizeCache;const e=(await this.storageManager.get(["selectionFontSize"])).selectionFontSize??14;return this.selectionFontSizeCache=e,e}enable(){this.enabled||(this.mouseUpHandler=this.handleMouseUp.bind(this),document.addEventListener("mouseup",this.mouseUpHandler),this.enabled=!0,a.log("SelectionHandler enabled"))}disable(){this.enabled&&this.mouseUpHandler&&(document.removeEventListener("mouseup",this.mouseUpHandler),this.mouseUpHandler=null,this.enabled=!1,this.iconBadge.hide(),a.log("SelectionHandler disabled"))}getSelectedText(){const e=window.getSelection();if(!e||0===e.rangeCount)return null;return e.toString().trim()||null}async translateSelection(e,t){if(this.isTranslating)return a.log("Translation already in progress, skipping"),null;const n=t||this.getSelectedText();if(!n)return a.log("No text selected for translation"),null;try{this.isTranslating=!0,a.log("Translating selection:",n.substring(0,50));const t=await this.messageBus.send({type:o.REQUEST_TRANSLATION,action:"requestTranslation",payload:{texts:[n],targetLanguage:e}});if(t?.success&&t?.data?.translations&&t.data.translations.length>0){const s=t.data.translations[0];return a.log("Translation successful, sending SELECTION_TRANSLATED message:",{originalText:n.substring(0,50),translatedText:s.substring(0,50),targetLanguage:e}),await this.messageBus.send({type:o.SELECTION_TRANSLATED,payload:{originalText:n,translatedText:s,targetLanguage:e,timestamp:Date.now()}}),a.log("SELECTION_TRANSLATED message sent successfully"),s}return a.warn("Empty translation response"),null}catch(e){return a.error("Failed to translate selection:",e),null}finally{this.isTranslating=!1}}handleMouseUp(e){setTimeout(async()=>{const e=this.getSelectedText();if(e){a.log("Text selected:",e.substring(0,50));const t=window.getSelection();t&&t.rangeCount>0&&(t.getRangeAt(0).getBoundingClientRect(),this.iconBadge.show({x:window.innerWidth-40,y:window.innerHeight/2},async()=>{try{const t=await this.storageManager.getTargetLanguage();if(!t)return a.warn("No target language configured"),void this.iconBadge.hide();const n=await this.translateSelection(t,e);a.log("[DEBUG] Selected text:",e.substring(0,100)),a.log("[DEBUG] Translated text:",n?n.substring(0,100):"null"),a.log("[DEBUG] Target language:",t),n&&e?await this.iconBadge.showTranslationResult(e,n,t,{x:window.innerWidth,y:0}):this.iconBadge.hide()}catch(e){a.error("Failed to handle IconBadge click:",e),this.iconBadge.hide()}}))}},10)}}class d{constructor(){this.messageBus=new n}async read(){try{if(!navigator.clipboard||!navigator.clipboard.readText)return a.warn("Clipboard API not available"),null;const e=(await navigator.clipboard.readText()).trim();return e?(a.log("Clipboard read:",e.substring(0,50)),e):(a.log("Clipboard is empty"),null)}catch(e){return a.error("Failed to read clipboard:",e),null}}async translateClipboard(e){try{const t=await this.read();if(!t)return a.log("No clipboard text to translate"),null;a.log("Translating clipboard content to",e);const n=await this.messageBus.send({type:o.REQUEST_TRANSLATION,action:"requestTranslation",payload:{texts:[t],targetLanguage:e}});return n?.success&&n?.data?.translations&&n.data.translations.length>0?n.data.translations[0]:(a.warn("Empty translation response for clipboard"),null)}catch(e){return a.error("Failed to translate clipboard:",e),null}}}class h{constructor(){this.observer=null,this.callback=null,this.isObserving=!1}observe(e){this.isObserving?a.log("MutationObserver already observing"):(this.callback=e,this.observer=new MutationObserver(e=>{try{this.callback&&Promise.resolve(this.callback(e)).catch(e=>{a.error("Error in async MutationObserver callback:",e)})}catch(e){a.error("Error in MutationObserver callback:",e)}}),this.observer.observe(document.body,{childList:!0,subtree:!0,characterData:!0,characterDataOldValue:!1,attributes:!0,attributeFilter:["class","style","hidden","aria-hidden","aria-expanded","open"]}),this.isObserving=!0,a.log("MutationObserver started"))}disconnect(){this.isObserving&&this.observer&&(this.observer.disconnect(),this.observer=null,this.callback=null,this.isObserving=!1,a.log("MutationObserver disconnected"))}}class g{constructor(){this.floatingElement=null,this.translation="",this.autoHideTimer=null}show(e,t){this.hide(),this.translation=e,this.floatingElement=this.createFloatingElement();const n=this.createTextElement(e);this.floatingElement.appendChild(n);const o=this.createCopyButton();this.floatingElement.appendChild(o),document.body.appendChild(this.floatingElement),this.positionElement(t),a.log("FloatingUI shown at",t)}showError(e,t){this.hide(),this.translation=e,this.floatingElement=this.createErrorElement(e),document.body.appendChild(this.floatingElement),this.positionElement(t),this.autoHideTimer=window.setTimeout(()=>{this.hide()},5e3),a.log("FloatingUI: Showing error at",t)}hide(){null!==this.autoHideTimer&&(window.clearTimeout(this.autoHideTimer),this.autoHideTimer=null),this.floatingElement&&this.floatingElement.parentNode&&(this.floatingElement.parentNode.removeChild(this.floatingElement),this.floatingElement=null,a.log("FloatingUI hidden"))}createCopyButton(){const e=document.createElement("button");return e.className="copy-button",e.textContent="Copy",e.type="button",Object.assign(e.style,{marginTop:"8px",padding:"6px 12px",backgroundColor:"#4F46E5",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"14px",fontWeight:"500"}),e.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(this.translation),e.textContent="Copied!",e.style.backgroundColor="#10B981",setTimeout(()=>{e.textContent="Copy",e.style.backgroundColor="#4F46E5"},2e3),a.log("Translation copied to clipboard")}catch(t){a.error("Failed to copy to clipboard:",t),e.textContent="Error",e.style.backgroundColor="#EF4444",setTimeout(()=>{e.textContent="Copy",e.style.backgroundColor="#4F46E5"},2e3)}}),e}createFloatingElement(){const e=document.createElement("div");e.className="floating-translation";const t=window.matchMedia("(prefers-color-scheme: dark)").matches;return Object.assign(e.style,{position:"fixed",zIndex:"10000",backgroundColor:t?"#1F2937":"#FFFFFF",color:t?"#F3F4F6":"#1F2937",padding:"16px",borderRadius:"8px",boxShadow:"0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)",maxWidth:"400px",minWidth:"200px",display:"flex",flexDirection:"column",border:t?"1px solid #374151":"1px solid #E5E7EB"}),e}createTextElement(e){const t=document.createElement("div");return t.className="translation-text",t.textContent=e,Object.assign(t.style,{fontSize:"14px",lineHeight:"1.5",wordBreak:"break-word",marginBottom:"8px"}),t}createErrorElement(e){const t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,n=document.createElement("div");n.className="floating-translation floating-error",Object.assign(n.style,{position:"fixed",zIndex:"10000",backgroundColor:t?"#dc2626":"#fee2e2",color:t?"#fef2f2":"#991b1b",padding:"12px 16px",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",maxWidth:"300px",minWidth:"200px",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',border:t?"1px solid #b91c1c":"1px solid #fecaca"});const o=document.createElement("div");return o.className="translation-text",o.textContent=e,Object.assign(o.style,{fontSize:"14px",lineHeight:"1.5",wordBreak:"break-word"}),n.appendChild(o),n}positionElement(e){if(!this.floatingElement)return;let{x:t,y:n}=e;t=Math.max(0,t),n=Math.max(0,n),t+=10,n+=10;const o=this.floatingElement.getBoundingClientRect();t+o.width>window.innerWidth&&(t=window.innerWidth-o.width-10),n+o.height>window.innerHeight&&(n=window.innerHeight-o.height-10),t=Math.max(0,t),n=Math.max(0,n),this.floatingElement.style.left=`${t}px`,this.floatingElement.style.top=`${n}px`}}const p="20px",u="20px",m="#4F46E5",E="#EF4444",T="#FFFFFF",y="rgba(0,0,0,0.1)",C="rgba(255,255,255,0.2)",f="#FFFFFF",w="16px 20px",S="280px",b="400px",x="8px",N="6px",R="system-ui, -apple-system, sans-serif",A="14px",v="500",F="0 4px 12px rgba(0, 0, 0, 0.15)",M="0 4px 12px rgba(0, 0, 0, 0.4)",P="fadeIn 0.3s ease",L="width 0.3s ease",k=3e3;class O{constructor(){this.container=null,this.progressBar=null,this.messageElement=null,this.autoHideTimer=null,this.currentPhase=null,this.isDarkMode=this.detectDarkMode(),a.log("ProgressNotification initialized",{isDarkMode:this.isDarkMode})}detectDarkMode(){return"undefined"!=typeof window&&(window.matchMedia?.("(prefers-color-scheme: dark)")?.matches??!1)}show(e){a.log("ProgressNotification.show() called",{total:e}),this.remove(),this.container=document.createElement("div"),this.container.className="progress-notification",this.applyContainerStyles(this.container,!1),this.messageElement=this.createMessageElement();const t=this.createProgressBarContainer();this.progressBar=this.createProgressBar(),t.appendChild(this.progressBar),this.container.appendChild(this.messageElement),this.container.appendChild(t),document.body.appendChild(this.container),a.log("ProgressNotification shown")}update(e,t){if(!this.container||!this.progressBar||!this.messageElement)return void a.warn("ProgressNotification.update() called but notification not shown");const n=t>0?Math.min(100,Math.round(e/t*100)):0;this.messageElement.textContent=`翻訳中... ${n}%`,this.progressBar.style.width=`${n}%`,a.log("ProgressNotification updated",{current:e,total:t,percentage:n})}updatePhase(e,t,n){if(!this.container||!this.progressBar)return void a.warn("ProgressNotification.updatePhase() called but notification not shown");let o;if(void 0!==n){if(this.currentPhase=e,o=n>0?Math.min(100,Math.round(t/n*100)):0,this.messageElement){const t=1===e?`ビューポート内を翻訳中... ${o}%`:`ページ全体を翻訳中... ${o}%`;this.messageElement.textContent=t}}else o=Math.max(0,Math.min(100,Math.round(t)));this.progressBar.style.width=`${o}%`,a.log("ProgressNotification phase updated",{phase:e,percentage:o})}complete(){this.container&&this.progressBar&&this.messageElement?(this.messageElement.textContent="翻訳完了 100%",this.progressBar.style.width="100%",this.autoHideTimer=setTimeout(()=>{this.remove()},k),a.log("ProgressNotification completed, will auto-hide in 3s")):a.warn("ProgressNotification.complete() called but notification not shown")}error(e){this.container&&this.messageElement||(a.warn("ProgressNotification.error() called but notification not shown"),this.show(0)),this.container&&this.messageElement&&(this.messageElement.textContent=`エラー: ${e}`,this.applyContainerStyles(this.container,!0),this.autoHideTimer&&(clearTimeout(this.autoHideTimer),this.autoHideTimer=null),a.error("ProgressNotification error displayed",{errorMessage:e}))}remove(){this.autoHideTimer&&(clearTimeout(this.autoHideTimer),this.autoHideTimer=null),document.querySelectorAll(".progress-notification").forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)}),this.container=null,this.progressBar=null,this.messageElement=null,a.log("ProgressNotification removed")}createMessageElement(){const e=document.createElement("div");return e.className="progress-message",e.textContent="翻訳を開始しています... 0%",e.style.marginBottom="8px",e.style.fontSize=A,e.style.fontWeight=v,e}createProgressBarContainer(){const e=document.createElement("div");return e.className="progress-bar-container",e.style.width="100%",e.style.height=N,e.style.backgroundColor=this.isDarkMode?C:y,e.style.borderRadius="3px",e.style.overflow="hidden",e}createProgressBar(){const e=document.createElement("div");return e.className="progress-bar",e.style.width="0%",e.style.height="100%",e.style.backgroundColor=f,e.style.transition=L,e.style.borderRadius="3px",e}applyContainerStyles(e,t){e.style.position="fixed",e.style.bottom=p,e.style.right=u,e.style.zIndex="10001",e.style.padding=w,e.style.borderRadius=x,e.style.minWidth=S,e.style.maxWidth=b,e.style.color=T,e.style.fontFamily=R,e.style.backgroundColor=t?E:m,e.style.boxShadow=this.isDarkMode?M:F,e.style.animation=P,this.injectAnimationStyles()}injectAnimationStyles(){if(!document.querySelector("#progress-notification-styles")){const e=document.createElement("style");e.id="progress-notification-styles",e.textContent="\n  @keyframes fadeIn {\n    from {\n      opacity: 0;\n      transform: translateY(10px);\n    }\n    to {\n      opacity: 1;\n      transform: translateY(0);\n    }\n  }\n",document.head.appendChild(e)}}showPhase(e,t){this.currentPhase=e,this.remove(),this.container=document.createElement("div"),this.container.className="progress-notification",this.applyContainerStyles(this.container,!1),this.messageElement=this.createMessageElement();const n=1===e?"ビューポート内を翻訳中... 0%":"ページ全体を翻訳中... 0%";this.messageElement.textContent=n;const o=this.createProgressBarContainer();this.progressBar=this.createProgressBar(),o.appendChild(this.progressBar),this.container.appendChild(this.messageElement),this.container.appendChild(o),document.body.appendChild(this.container),a.log(`ProgressNotification.showPhase(${e}, ${t}) called`)}completePhase(e){if(!this.container||!this.messageElement)return void a.warn("ProgressNotification.completePhase() called but notification not shown");const t=1===e?"ビューポート内の翻訳完了":"ページ全体の翻訳完了";this.messageElement.textContent=t,a.log(`ProgressNotification.completePhase(${e})`)}}function $(e){const t=[],n=new Map,o=[];return e.forEach((e,s)=>{const a=function(e){const t=e.trim(),n=/[\p{Script=Han}\p{Script=Hiragana}\p{Script=Katakana}\p{Script=Hangul}]/u.test(t);return 0===t.length||t.length<2&&!n?{shouldTranslate:!1,reason:"too_short"}:/^[\d\s.\-+(),/:]+$/.test(t)?{shouldTranslate:!1,reason:"numbers_only"}:/^(https?:\/\/|www\.|[\w.+-]+@[\w.-]+\.\w+)/i.test(t)?{shouldTranslate:!1,reason:"url_or_email"}:/^[\s\p{P}\p{S}]+$/u.test(t)?{shouldTranslate:!1,reason:"symbols_only"}:!/\s/.test(t)&&(/^[a-zA-Z0-9]+(?:_[a-zA-Z0-9]+)+$/.test(t)||/\$[a-zA-Z_\{]/.test(t)||/[a-z][A-Z]/.test(t)||/^[A-Z][A-Z0-9_]{4,}$/.test(t)||/^[a-zA-Z_$][a-zA-Z0-9_$]*\(\)$/.test(t))?{shouldTranslate:!1,reason:"code_like"}:{shouldTranslate:!0}}(e);a.shouldTranslate?(t.push(e),o.push(s)):n.set(s,e)}),console.log(`[TextFilter] Filtered ${e.length} texts: ${t.length} to translate, ${n.size} skipped`),{textsToTranslate:t,skippedIndices:n,originalIndices:o}}const I=["script","style","noscript","iframe","svg","canvas","code","pre",'[contenteditable="true"]',"[data-no-translate]",".no-translate"].join(", ");class D{constructor(){this.isTranslated=!1,this.extractedNodes=[],this.currentTranslationNodes=[],this.lastObservedNodeText=new WeakMap,this.pendingDynamicNodes=new Set,this.isDynamicFlushScheduled=!1,this.domManipulator=new e,this.selectionHandler=new c,this.clipboardHandler=new d,this.mutationObserver=new h,this.floatingUI=new g,this.progressNotification=new O,this.messageBus=new n,a.log("ContentScript initialized")}initialize(){this.messageBus.listen(this.handleMessage.bind(this)),this.selectionHandler.enable(),a.log("ContentScript ready")}async handleMessage(e,t,n){const s=(new Date).toISOString();console.log(`[Content:ContentScript] ${s} - handleMessage() called:`,{messageType:e.type,payload:"payload"in e?e.payload:void 0}),a.log("ContentScript received message:",e.type);try{switch(e.type){case o.TRANSLATE_PAGE:console.log(`[Content:ContentScript] ${s} - Handling TRANSLATE_PAGE:`,{targetLanguage:"payload"in e?e.payload.targetLanguage:"en"}),await this.translatePage("payload"in e?e.payload.targetLanguage:"en"),console.log(`[Content:ContentScript] ${s} - TRANSLATE_PAGE completed successfully`),n({success:!0});break;case o.TRANSLATE_SELECTION:console.log(`[Content:ContentScript] ${s} - Handling TRANSLATE_SELECTION`),await this.translateSelection("payload"in e?e.payload.targetLanguage:"en"),console.log(`[Content:ContentScript] ${s} - TRANSLATE_SELECTION completed successfully`),n({success:!0});break;case o.TRANSLATE_CLIPBOARD:console.log(`[Content:ContentScript] ${s} - Handling TRANSLATE_CLIPBOARD`),await this.translateClipboard("payload"in e?e.payload.targetLanguage:"en"),console.log(`[Content:ContentScript] ${s} - TRANSLATE_CLIPBOARD completed successfully`),n({success:!0});break;case o.RESET:console.log(`[Content:ContentScript] ${s} - Handling RESET`),this.reset(),console.log(`[Content:ContentScript] ${s} - RESET completed successfully`),n({success:!0});break;case o.TRANSLATION_PROGRESS:if(console.log(`[Content:ContentScript] ${s} - Handling TRANSLATION_PROGRESS`),"payload"in e&&e.payload){const{current:t,total:n}=e.payload;"number"==typeof t&&"number"==typeof n&&this.progressNotification.update(t,n)}n({success:!0});break;case o.TRANSLATION_ERROR:console.log(`[Content:ContentScript] ${s} - Handling TRANSLATION_ERROR`),"payload"in e&&e.payload&&void 0!==e.payload.error&&(this.progressNotification.error(e.payload.error),a.error("Translation error received:",e.payload.error)),n({success:!0});break;case o.BATCH_COMPLETED:console.log(`[Content:ContentScript] ${s} - Handling BATCH_COMPLETED`),"payload"in e&&e.payload&&this.handleBatchCompleted(e.payload),n({success:!0});break;default:console.warn(`[Content:ContentScript] ${s} - Unknown message type:`,e.type),a.log("Unknown message type:",e.type),n({success:!1,error:"Unknown message type"})}}catch(e){console.error(`[Content:ContentScript] ${s} - Error handling message:`,{error:e,message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),a.error("Error handling message:",e),n({success:!1,error:String(e)})}}async translatePage(e){const t=(new Date).toISOString();console.log(`[Content:ContentScript] ${t} - translatePage() called:`,{targetLanguage:e});try{if(a.log("Translating page to",e),console.log(`[Content:ContentScript] ${t} - Extracting text nodes from DOM...`),this.extractedNodes=this.domManipulator.extractTextNodes(),console.log(`[Content:ContentScript] ${t} - Text nodes extracted:`,{count:this.extractedNodes.length}),0===this.extractedNodes.length)return console.warn(`[Content:ContentScript] ${t} - No text nodes to translate`),void a.log("No text nodes to translate");console.log(`[Content:ContentScript] ${t} - Detecting viewport nodes...`);const{viewport:n,outOfViewport:s}=this.domManipulator.detectViewportNodes(this.extractedNodes);if(console.log(`[Content:ContentScript] ${t} - Viewport detection completed:`,{viewportCount:n.length,outOfViewportCount:s.length}),n.length>0){console.log(`[Content:ContentScript] ${t} - Starting Phase 1: Viewport translation`),this.progressNotification.showPhase(1,n.length);const s=n.map(e=>e.text),{textsToTranslate:a,originalIndices:i}=$(s);if(0===a.length)console.log(`[Content:ContentScript] ${t} - Phase 1 skipped: All texts filtered`),this.progressNotification.completePhase(1);else{this.currentTranslationNodes=i.map(e=>n[e]),console.log(`[Content:ContentScript] ${t} - Sending Phase 1 REQUEST_TRANSLATION:`,{type:o.REQUEST_TRANSLATION,action:"requestTranslation",textsCount:a.length,filteredFrom:s.length,targetLanguage:e,semiParallel:!0,priorityCount:1,phase:1});const r=await this.messageBus.send({type:o.REQUEST_TRANSLATION,action:"requestTranslation",payload:{texts:a,targetLanguage:e,semiParallel:!0,priorityCount:1,phase:1}});if(console.log(`[Content:ContentScript] ${t} - Phase 1 response received:`,{success:r?.success,hasTranslations:!!r?.data?.translations}),r?.success&&r?.data?.translations){console.log(`[Content:ContentScript] ${t} - Applying Phase 1 translations`);const e=i.map(e=>n[e]);this.applyTranslationsAndTrack(e,r.data.translations),this.progressNotification.completePhase(1),console.log(`[Content:ContentScript] ${t} - Phase 1 completed with all translations applied`)}else console.warn(`[Content:ContentScript] ${t} - Phase 1 failed:`,r);console.log(`[Content:ContentScript] ${t} - Phase 1 request completed (batches were applied via BATCH_COMPLETED)`)}}else console.log(`[Content:ContentScript] ${t} - Phase 1 skipped: No viewport nodes`);if(s.length>0){console.log(`[Content:ContentScript] ${t} - Starting Phase 2: Full-page translation`),this.progressNotification.showPhase(2,s.length);const n=s.map(e=>e.text),{textsToTranslate:a,originalIndices:i}=$(n);if(a.length>0){console.log(`[Content:ContentScript] ${t} - Sending Phase 2 REQUEST_TRANSLATION:`,{type:o.REQUEST_TRANSLATION,action:"requestTranslation",textsCount:a.length,filteredFrom:n.length,targetLanguage:e,semiParallel:!0,priorityCount:0,phase:2}),this.currentTranslationNodes=i.map(e=>s[e]);const r=await this.messageBus.send({type:o.REQUEST_TRANSLATION,action:"requestTranslation",payload:{texts:a,targetLanguage:e,semiParallel:!0,priorityCount:0,phase:2}});if(console.log(`[Content:ContentScript] ${t} - Phase 2 response received:`,{success:r?.success,hasTranslations:!!r?.data?.translations}),r?.success&&r?.data?.translations){console.log(`[Content:ContentScript] ${t} - Applying Phase 2 translations`);const e=i.map(e=>s[e]);this.applyTranslationsAndTrack(e,r.data.translations),this.progressNotification.completePhase(2),console.log(`[Content:ContentScript] ${t} - Phase 2 completed`)}else console.warn(`[Content:ContentScript] ${t} - Phase 2 failed:`,r)}else console.log(`[Content:ContentScript] ${t} - Phase 2 skipped: All texts filtered`),this.progressNotification.completePhase(2)}else console.log(`[Content:ContentScript] ${t} - Phase 2 skipped: No out-of-viewport nodes`);this.isTranslated=!0,this.progressNotification.complete(),this.enableDynamicTranslation(e),console.log(`[Content:ContentScript] ${t} - Page translation completed successfully`),a.log("Page translation completed")}catch(e){throw console.error(`[Content:ContentScript] ${t} - Failed to translate page:`,{error:e,message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),a.error("Failed to translate page:",e),this.progressNotification.error(e instanceof Error?e.message:"Translation failed"),e}}async translateSelection(e){try{const t=await this.selectionHandler.translateSelection(e);if(t){const e=window.getSelection();if(e&&e.rangeCount>0){const n=e.getRangeAt(0).getBoundingClientRect();this.floatingUI.show(t,{x:n.left+window.scrollX,y:n.bottom+window.scrollY}),a.log("Selection translation displayed")}}else a.log("No selection to translate")}catch(e){throw a.error("Failed to translate selection:",e),e}}async translateClipboard(e){try{const t=await this.clipboardHandler.translateClipboard(e);t?(this.floatingUI.show(t,{x:window.innerWidth/2-200,y:window.innerHeight/2-100}),a.log("Clipboard translation displayed")):a.log("No clipboard content to translate")}catch(e){throw a.error("Failed to translate clipboard:",e),e}}reset(){try{this.isTranslated=!1,this.domManipulator.reset(),this.floatingUI.hide(),this.pendingDynamicNodes.clear(),this.isDynamicFlushScheduled=!1,this.lastObservedNodeText=new WeakMap,a.log("Page reset to original state")}catch(e){throw a.error("Failed to reset page:",e),e}}enableDynamicTranslation(e){this.mutationObserver.observe(t=>{const n=new Set;for(const e of t)if("childList"!==e.type){if("characterData"===e.type){const t=e.target;t.nodeType===Node.TEXT_NODE&&this.isTextNodeTranslatable(t)&&n.add(t);continue}if("attributes"===e.type){const t=e.target;t.nodeType===Node.ELEMENT_NODE&&this.collectTextNodesFromElement(t,n)}}else for(const t of Array.from(e.addedNodes))this.collectTextNodesFromAddedNode(t,n);n.size>0&&this.isTranslated&&(a.log(`Dynamic content: ${n.size} candidate text nodes detected`),this.queueDynamicTranslation(n,e))}),a.log("Dynamic translation enabled")}disableDynamicTranslation(){this.mutationObserver.disconnect(),this.pendingDynamicNodes.clear(),this.isDynamicFlushScheduled=!1,a.log("Dynamic translation disabled")}handleBatchCompleted(e){const t=(new Date).toISOString();console.log(`[Content:ContentScript] ${t} - handleBatchCompleted() called:`,e);try{const{translations:n,nodeIndices:o,phase:s,progress:i}=e;if(!this.currentTranslationNodes||0===this.currentTranslationNodes.length)return void console.warn(`[Content:ContentScript] ${t} - currentTranslationNodes is empty, skipping batch application`);const r=o.filter(e=>e<this.currentTranslationNodes.length).map(e=>this.currentTranslationNodes[e]);r.length!==n.length&&console.warn(`[Content:ContentScript] ${t} - Mismatch: nodes(${r.length}) vs translations(${n.length})`),console.log(`[Content:ContentScript] ${t} - Applying batch translations:`,{nodesCount:r.length,translationsCount:n.length,phase:s,progress:i}),this.applyTranslationsAndTrack(r,n),"number"==typeof i?.percentage&&this.progressNotification.updatePhase(s,i.percentage),console.log(`[Content:ContentScript] ${t} - Batch applied successfully:`,`Progress: ${i.current}/${i.total} (${i.percentage}%)`),a.log(`Batch ${e.batchIndex} completed: ${n.length} texts translated`)}catch(e){console.error(`[Content:ContentScript] ${t} - Failed to handle batch completed:`,{error:e,message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),a.error("Failed to handle batch completed:",e)}}async translateNewNodes(e,t){try{const n=Array.from(new Set(e)).filter(e=>{if(!this.isTextNodeTranslatable(e))return!1;const t=e.textContent?.trim()||"";return this.lastObservedNodeText.get(e)!==t});if(0===n.length)return;const s=n.map((e,t)=>({node:e,text:e.textContent?.trim()||"",index:t})),a=s.map(e=>e.text),{textsToTranslate:i,originalIndices:r}=$(a);if(0===i.length)return void n.forEach(e=>this.trackNodeText(e));const l=await this.messageBus.send({type:o.REQUEST_TRANSLATION,action:"requestTranslation",payload:{texts:i,targetLanguage:t,semiParallel:!1}});if(l?.success&&l?.data?.translations){const e=r.map(e=>s[e]);this.applyTranslationsAndTrack(e,l.data.translations);const t=new Set(r);s.forEach((e,n)=>{t.has(n)||this.trackNodeText(e.node)})}}catch(e){a.error("Failed to translate new nodes:",e)}}applyTranslationsAndTrack(e,t){this.domManipulator.applyTranslations(e,t),e.forEach((e,n)=>{t[n]&&t[n].trim()&&this.trackNodeText(e.node)})}trackNodeText(e){const t=e.textContent?.trim();t&&this.lastObservedNodeText.set(e,t)}queueDynamicTranslation(e,t){for(const t of e)this.pendingDynamicNodes.add(t);this.isDynamicFlushScheduled||(this.isDynamicFlushScheduled=!0,queueMicrotask(()=>{if(this.isDynamicFlushScheduled=!1,!this.isTranslated||0===this.pendingDynamicNodes.size)return void this.pendingDynamicNodes.clear();const e=Array.from(this.pendingDynamicNodes);this.pendingDynamicNodes.clear(),this.translateNewNodes(e,t)}))}collectTextNodesFromAddedNode(e,t){if(e.nodeType===Node.TEXT_NODE)return void(this.isTextNodeTranslatable(e)&&t.add(e));if(e.nodeType!==Node.ELEMENT_NODE)return;const n=e;n.matches(I)||n.closest(I)||this.collectTextNodesFromElement(n,t)}collectTextNodesFromElement(e,t){if(e.matches(I)||e.closest(I))return;const n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:e=>this.isTextNodeTranslatable(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT});let o;for(;o=n.nextNode();)t.add(o)}isTextNodeTranslatable(e){if(e.nodeType!==Node.TEXT_NODE)return!1;if(!e.textContent?.trim())return!1;const t=e.parentElement;return!!t&&!t.closest(I)&&!!this.isElementVisible(t)}isElementVisible(e){if(e.closest('[hidden], [aria-hidden="true"]'))return!1;let t=e;for(;t;){if(t.hasAttribute("hidden")||"true"===t.getAttribute("aria-hidden"))return!1;const e=window.getComputedStyle(t);if("none"===e.display||"hidden"===e.visibility)return!1;t=t.parentElement}return!0}cleanup(){this.selectionHandler.disable(),this.mutationObserver.disconnect(),this.pendingDynamicNodes.clear(),this.isDynamicFlushScheduled=!1,this.floatingUI.hide(),this.progressNotification.remove(),a.log("ContentScript cleaned up")}}"undefined"!=typeof chrome&&chrome.runtime?chrome:window.browser;let B=null;try{B=new D,B.initialize(),a.log("DoganayLab Translate - Content Script initialized")}catch(e){a.error("Failed to initialize content script:",e)}window.addEventListener("beforeunload",()=>{B&&B.cleanup()})})();