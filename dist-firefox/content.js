(()=>{"use strict";class e{constructor(){this.originalTextMap=new WeakMap,this.IGNORED_TAGS=["SCRIPT","STYLE","NOSCRIPT","IFRAME"],this.extractedTextsSet=new Set}extractTextNodes(){const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:e=>{const t=e.parentElement;return t?this.IGNORED_TAGS.includes(t.tagName)?NodeFilter.FILTER_REJECT:e.textContent?.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT:NodeFilter.FILTER_REJECT}}),t=[];let n,o=0;for(this.extractedTextsSet.clear();n=e.nextNode();){const e=(n.textContent||"").trim();this.saveOriginalText(n),t.push({node:n,text:e,index:o}),this.extractedTextsSet.add(e),o++}return t}applyTranslations(e,t){e.forEach((e,n)=>{t[n]&&t[n].trim()&&(e.node.textContent=t[n])})}reset(){const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT);let t;for(;t=e.nextNode();){const e=this.originalTextMap.get(t);void 0!==e&&(t.textContent=e)}}saveOriginalText(e){this.originalTextMap.has(e)||this.originalTextMap.set(e,e.textContent||"")}detectViewportNodes(e){const t=[],n=[];return e.forEach(e=>{const o=e.node.parentElement;if(!o)return void n.push(e);const a=o.getBoundingClientRect();a.top<window.innerHeight&&a.bottom>0&&a.left<window.innerWidth&&a.right>0?t.push(e):n.push(e)}),{viewport:t,outOfViewport:n}}}const t=new class{constructor(){this.api="undefined"!=typeof chrome&&chrome.runtime?chrome:browser}handleRuntimeError(e,t,n){this.api.runtime.lastError?t(new Error(this.api.runtime.lastError.message)):e(n)}get isChrome(){return"undefined"!=typeof chrome&&!!chrome.runtime}get isFirefox(){return!this.isChrome&&"undefined"!=typeof browser&&!!browser.runtime}get manifestVersion(){return this.api.runtime.getManifest().manifest_version}get storage(){return{get:e=>new Promise((t,n)=>{this.api.storage.local.get(e,e=>{this.handleRuntimeError(t,n,e)})}),set:e=>new Promise((t,n)=>{this.api.storage.local.set(e,()=>{this.handleRuntimeError(t,n,void 0)})}),remove:e=>new Promise((t,n)=>{this.api.storage.local.remove(e,()=>{this.handleRuntimeError(t,n,void 0)})})}}get runtime(){return{sendMessage:e=>new Promise(t=>{this.api.runtime.sendMessage(e,e=>{t(e)})}),onMessage:this.api.runtime.onMessage,getManifest:()=>this.api.runtime.getManifest(),openOptionsPage:()=>this.api.runtime.openOptionsPage()}}get tabs(){return{query:e=>new Promise(t=>{this.api.tabs.query(e,t)}),sendMessage:(e,t)=>new Promise(n=>{this.api.tabs.sendMessage(e,t,e=>{n(e)})})}}get commands(){return{onCommand:this.api.commands.onCommand}}};class n{constructor(){this.listeners=new Map}async send(e){const n={...e,timestamp:e.timestamp||Date.now()};return t.runtime.sendMessage(n)}async sendToTab(e,n){const o={...n,timestamp:n.timestamp||Date.now()};return t.tabs.sendMessage(e,o)}listen(e,n){const o=(t,o,a)=>(!n||t.type===n)&&(e(t,o,a)||!1);this.listeners.set(e,o),t.runtime.onMessage.addListener(o)}unlisten(e){const n=this.listeners.get(e);n&&(t.runtime.onMessage.removeListener(n),this.listeners.delete(e))}}var o;function a(e){return`${function(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:${String(e.getSeconds()).padStart(2,"0")}`}()} [${e}]`}new n,function(e){e.TRANSLATE_PAGE="translate",e.TRANSLATE_SELECTION="translateSelection",e.TRANSLATE_CLIPBOARD="translateClipboard",e.REQUEST_TRANSLATION="requestTranslation",e.RESET="reset",e.TRANSLATION_STARTED="translationStarted",e.TRANSLATION_PROGRESS="translationProgress",e.TRANSLATION_COMPLETED="translationCompleted",e.TRANSLATION_ERROR="translationError",e.SELECTION_TRANSLATED="selectionTranslated",e.BATCH_COMPLETED="batchCompleted",e.SETTINGS_CHANGED="settingsChanged",e.API_KEY_UPDATED="apiKeyUpdated",e.RELOAD_CONFIG="reloadConfig",e.TEST_CONNECTION="testConnection"}(o||(o={}));const s={log(e,...t){},warn(e,...t){const n=a("WARN");console.warn(`${n} ${e}`,...t)},error(e,...t){const n=a("ERROR");console.error(`${n} ${e}`,...t)}};new Map([{code:"en",name:"English",nameEn:"English"},{code:"ja",name:"日本語",nameEn:"Japanese"},{code:"zh",name:"中文",nameEn:"Chinese (Simplified)"},{code:"zh-TW",name:"中文 (繁體)",nameEn:"Chinese (Traditional)"},{code:"ko",name:"한국어",nameEn:"Korean"},{code:"es",name:"Español",nameEn:"Spanish"},{code:"fr",name:"Français",nameEn:"French"},{code:"de",name:"Deutsch",nameEn:"German"},{code:"it",name:"Italiano",nameEn:"Italian"},{code:"pt",name:"Português",nameEn:"Portuguese"},{code:"ru",name:"Русский",nameEn:"Russian"},{code:"ar",name:"العربية",nameEn:"Arabic"},{code:"hi",name:"हिन्दी",nameEn:"Hindi"},{code:"th",name:"ไทย",nameEn:"Thai"},{code:"vi",name:"Tiếng Việt",nameEn:"Vietnamese"},{code:"id",name:"Bahasa Indonesia",nameEn:"Indonesian"},{code:"tr",name:"Türkçe",nameEn:"Turkish"},{code:"pl",name:"Polski",nameEn:"Polish"},{code:"nl",name:"Nederlands",nameEn:"Dutch"},{code:"sv",name:"Svenska",nameEn:"Swedish"}].map(e=>[e.code,e]));const i={openRouterApiKey:void 0,targetLanguage:"ja",fontSize:16,lineHeight:1.5,darkMode:!1,openRouterModel:"",schemaVersion:3,selectionFontSize:14},r=class{async get(e){try{console.log("[StorageManager] get() called with keys:",e);const n=e?await t.storage.get(e):await t.storage.get([]);console.log("[StorageManager] Raw data from BrowserAdapter:",n),console.log("[StorageManager] Data keys:",Object.keys(n)),console.log("[StorageManager] openRouterApiKey:",n.openRouterApiKey),console.log("[StorageManager] openRouterModel:",n.openRouterModel),n.lineHeight&&n.lineHeight>2&&(n.lineHeight=1.5,await this.set({lineHeight:1.5}));const o={...i,...n};return console.log("[StorageManager] Merged result:",o),console.log("[StorageManager] Result openRouterApiKey:",o.openRouterApiKey),console.log("[StorageManager] Result openRouterModel:",o.openRouterModel),o}catch(e){return console.error("[StorageManager] get error:",e),console.error("[StorageManager] Returning DEFAULT_STORAGE due to error"),i}}async set(e){try{await t.storage.set(e)}catch(e){throw console.error("StorageManager.set error:",e),e}}async remove(e){try{await t.storage.remove(e)}catch(e){throw console.error("StorageManager.remove error:",e),e}}async clear(){try{const e="undefined"!=typeof chrome?chrome:browser;return new Promise(t=>{e.storage.local.clear(()=>{t()})})}catch(e){throw console.error("StorageManager.clear error:",e),e}}async getApiKey(){try{return(await this.get(["openRouterApiKey"])).openRouterApiKey||null}catch(e){return console.error("StorageManager.getApiKey error:",e),null}}async setApiKey(e){try{await this.set({openRouterApiKey:e})}catch(e){throw console.error("StorageManager.setApiKey error:",e),e}}async getTargetLanguage(){try{return(await this.get(["targetLanguage"])).targetLanguage||i.targetLanguage}catch(e){return console.error("StorageManager.getTargetLanguage error:",e),i.targetLanguage}}async setTargetLanguage(e){try{await this.set({targetLanguage:e})}catch(e){throw console.error("StorageManager.setTargetLanguage error:",e),e}}};class l{constructor(){this.badgeElement=null,this.clickHandler=null,this.floatingResultElement=null,this.storageManager=new r}show(e,t){this.hide(),this.clickHandler=t,this.badgeElement=this.createBadgeElement(),this.badgeElement.addEventListener("click",this.handleClick.bind(this)),document.body.appendChild(this.badgeElement),this.positionElement(e),s.log("IconBadge shown at",e)}hide(){this.badgeElement&&this.badgeElement.parentNode&&(this.badgeElement.parentNode.removeChild(this.badgeElement),this.badgeElement=null,this.clickHandler=null,s.log("IconBadge hidden"))}async showTranslationResult(e,t,n,o){this.hide(),this.hideFloatingResult(),this.floatingResultElement=await this.createFloatingResultElement(e,t,n),document.body.appendChild(this.floatingResultElement),this.positionFloatingResult(o),s.log("FloatingUI translation result shown at",o)}hideFloatingResult(){this.floatingResultElement&&this.floatingResultElement.parentNode&&(this.floatingResultElement.parentNode.removeChild(this.floatingResultElement),this.floatingResultElement=null,s.log("FloatingUI translation result hidden"))}createBadgeElement(){const e=document.createElement("div");e.className="icon-badge";const t=window.matchMedia("(prefers-color-scheme: dark)").matches;return Object.assign(e.style,{position:"fixed",zIndex:"10002",width:"32px",height:"32px",borderRadius:"50%",backgroundColor:t?"#6366F1":"#4F46E5",color:"white",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",transition:"all 0.2s ease",fontSize:"16px",fontWeight:"bold",userSelect:"none"}),e.textContent="T",e.addEventListener("mouseenter",()=>{e.style.transform="scale(1.1)",e.style.boxShadow="0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)"}),e.addEventListener("mouseleave",()=>{e.style.transform="scale(1)",e.style.boxShadow="0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)"}),e}positionElement(e){if(!this.badgeElement)return;const t=this.badgeElement.getBoundingClientRect(),n=t.width||32,o=t.height||32,a=window.innerWidth-n-8,s=(window.innerHeight-o)/2;this.badgeElement.style.left=`${a}px`,this.badgeElement.style.top=`${s}px`}handleClick(){s.log("IconBadge clicked"),this.clickHandler&&this.clickHandler()}async createFloatingResultElement(e,t,n){const o=document.createElement("div");o.className="gemini-translate-floating-result";const a=(await this.storageManager.get(["selectionFontSize"])).selectionFontSize??14;o.style.setProperty("--selection-font-size",`${a}px`);const i=document.createElement("button");i.className="close-button",i.textContent="×",i.addEventListener("click",()=>{this.hideFloatingResult()});const r=document.createElement("div");r.className="header";const l=document.createElement("h3");l.textContent="翻訳結果";const c=document.createElement("span");c.className="target-language",c.textContent=n,r.appendChild(l),r.appendChild(c);const d=document.createElement("div");d.className="content";const g=document.createElement("div");g.className="text-section";const h=document.createElement("div");h.className="text-label",h.textContent="翻訳結果";const p=document.createElement("div");p.className="translated-text",p.textContent=t,g.appendChild(h),g.appendChild(p),d.appendChild(g);const m=document.createElement("div");m.className="actions";const u=document.createElement("button");return u.className="copy-button",u.textContent="コピー",u.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(t),u.textContent="コピーしました！",setTimeout(()=>{u.textContent="コピー"},2e3)}catch(e){s.error("Failed to copy to clipboard:",e),u.textContent="コピー失敗",setTimeout(()=>{u.textContent="コピー"},2e3)}}),m.appendChild(u),o.appendChild(i),o.appendChild(r),o.appendChild(d),o.appendChild(m),o}positionFloatingResult(e){this.floatingResultElement&&(this.floatingResultElement.style.position="fixed",this.floatingResultElement.style.right="0",this.floatingResultElement.style.top="0",this.floatingResultElement.style.bottom="0",this.floatingResultElement.style.width="400px",this.floatingResultElement.style.overflowY="auto",this.floatingResultElement.style.left="auto")}}class c{constructor(){this.enabled=!1,this.mouseUpHandler=null,this.isTranslating=!1,this.selectionFontSizeCache=null,this.messageBus=new n,this.iconBadge=new l,this.storageManager=new r,this.setupStorageListener()}setupStorageListener(){"undefined"!=typeof browser&&browser.storage&&browser.storage.onChanged&&browser.storage.onChanged.addListener((e,t)=>{"local"===t&&e.selectionFontSize&&(this.selectionFontSizeCache=null,s.log("Selection font size cache invalidated"))})}async getSelectionFontSize(){if(null!==this.selectionFontSizeCache)return this.selectionFontSizeCache;const e=(await this.storageManager.get(["selectionFontSize"])).selectionFontSize??14;return this.selectionFontSizeCache=e,e}enable(){this.enabled||(this.mouseUpHandler=this.handleMouseUp.bind(this),document.addEventListener("mouseup",this.mouseUpHandler),this.enabled=!0,s.log("SelectionHandler enabled"))}disable(){this.enabled&&this.mouseUpHandler&&(document.removeEventListener("mouseup",this.mouseUpHandler),this.mouseUpHandler=null,this.enabled=!1,this.iconBadge.hide(),s.log("SelectionHandler disabled"))}getSelectedText(){const e=window.getSelection();if(!e||0===e.rangeCount)return null;return e.toString().trim()||null}async translateSelection(e,t){if(this.isTranslating)return s.log("Translation already in progress, skipping"),null;const n=t||this.getSelectedText();if(!n)return s.log("No text selected for translation"),null;try{this.isTranslating=!0,s.log("Translating selection:",n.substring(0,50));const t=await this.messageBus.send({type:o.REQUEST_TRANSLATION,action:"requestTranslation",payload:{texts:[n],targetLanguage:e}});if(t?.success&&t?.data?.translations&&t.data.translations.length>0){const a=t.data.translations[0];return s.log("Translation successful, sending SELECTION_TRANSLATED message:",{originalText:n.substring(0,50),translatedText:a.substring(0,50),targetLanguage:e}),await this.messageBus.send({type:o.SELECTION_TRANSLATED,payload:{originalText:n,translatedText:a,targetLanguage:e,timestamp:Date.now()}}),s.log("SELECTION_TRANSLATED message sent successfully"),a}return s.warn("Empty translation response"),null}catch(e){return s.error("Failed to translate selection:",e),null}finally{this.isTranslating=!1}}handleMouseUp(e){setTimeout(async()=>{const e=this.getSelectedText();if(e){s.log("Text selected:",e.substring(0,50));const t=window.getSelection();t&&t.rangeCount>0&&(t.getRangeAt(0).getBoundingClientRect(),this.iconBadge.show({x:window.innerWidth-40,y:window.innerHeight/2},async()=>{try{const t=await this.storageManager.getTargetLanguage();if(!t)return s.warn("No target language configured"),void this.iconBadge.hide();const n=await this.translateSelection(t,e);s.log("[DEBUG] Selected text:",e.substring(0,100)),s.log("[DEBUG] Translated text:",n?n.substring(0,100):"null"),s.log("[DEBUG] Target language:",t),n&&e?await this.iconBadge.showTranslationResult(e,n,t,{x:window.innerWidth,y:0}):this.iconBadge.hide()}catch(e){s.error("Failed to handle IconBadge click:",e),this.iconBadge.hide()}}))}},10)}}class d{constructor(){this.messageBus=new n}async read(){try{if(!navigator.clipboard||!navigator.clipboard.readText)return s.warn("Clipboard API not available"),null;const e=(await navigator.clipboard.readText()).trim();return e?(s.log("Clipboard read:",e.substring(0,50)),e):(s.log("Clipboard is empty"),null)}catch(e){return s.error("Failed to read clipboard:",e),null}}async translateClipboard(e){try{const t=await this.read();if(!t)return s.log("No clipboard text to translate"),null;s.log("Translating clipboard content to",e);const n=await this.messageBus.send({type:o.REQUEST_TRANSLATION,action:"requestTranslation",payload:{texts:[t],targetLanguage:e}});return n?.success&&n?.data?.translations&&n.data.translations.length>0?n.data.translations[0]:(s.warn("Empty translation response for clipboard"),null)}catch(e){return s.error("Failed to translate clipboard:",e),null}}}class g{constructor(){this.observer=null,this.callback=null,this.isObserving=!1}observe(e){this.isObserving?s.log("MutationObserver already observing"):(this.callback=e,this.observer=new MutationObserver(e=>{try{this.callback&&this.callback(e)}catch(e){s.error("Error in MutationObserver callback:",e)}}),this.observer.observe(document.body,{childList:!0,subtree:!0}),this.isObserving=!0,s.log("MutationObserver started"))}disconnect(){this.isObserving&&this.observer&&(this.observer.disconnect(),this.observer=null,this.callback=null,this.isObserving=!1,s.log("MutationObserver disconnected"))}}class h{constructor(){this.floatingElement=null,this.translation="",this.autoHideTimer=null}show(e,t){this.hide(),this.translation=e,this.floatingElement=this.createFloatingElement();const n=this.createTextElement(e);this.floatingElement.appendChild(n);const o=this.createCopyButton();this.floatingElement.appendChild(o),document.body.appendChild(this.floatingElement),this.positionElement(t),s.log("FloatingUI shown at",t)}showError(e,t){this.hide(),this.translation=e,this.floatingElement=this.createErrorElement(e),document.body.appendChild(this.floatingElement),this.positionElement(t),this.autoHideTimer=window.setTimeout(()=>{this.hide()},5e3),s.log("FloatingUI: Showing error at",t)}hide(){null!==this.autoHideTimer&&(window.clearTimeout(this.autoHideTimer),this.autoHideTimer=null),this.floatingElement&&this.floatingElement.parentNode&&(this.floatingElement.parentNode.removeChild(this.floatingElement),this.floatingElement=null,s.log("FloatingUI hidden"))}createCopyButton(){const e=document.createElement("button");return e.className="copy-button",e.textContent="Copy",e.type="button",Object.assign(e.style,{marginTop:"8px",padding:"6px 12px",backgroundColor:"#4F46E5",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"14px",fontWeight:"500"}),e.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(this.translation),e.textContent="Copied!",e.style.backgroundColor="#10B981",setTimeout(()=>{e.textContent="Copy",e.style.backgroundColor="#4F46E5"},2e3),s.log("Translation copied to clipboard")}catch(t){s.error("Failed to copy to clipboard:",t),e.textContent="Error",e.style.backgroundColor="#EF4444",setTimeout(()=>{e.textContent="Copy",e.style.backgroundColor="#4F46E5"},2e3)}}),e}createFloatingElement(){const e=document.createElement("div");e.className="floating-translation";const t=window.matchMedia("(prefers-color-scheme: dark)").matches;return Object.assign(e.style,{position:"fixed",zIndex:"10000",backgroundColor:t?"#1F2937":"#FFFFFF",color:t?"#F3F4F6":"#1F2937",padding:"16px",borderRadius:"8px",boxShadow:"0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)",maxWidth:"400px",minWidth:"200px",display:"flex",flexDirection:"column",border:t?"1px solid #374151":"1px solid #E5E7EB"}),e}createTextElement(e){const t=document.createElement("div");return t.className="translation-text",t.textContent=e,Object.assign(t.style,{fontSize:"14px",lineHeight:"1.5",wordBreak:"break-word",marginBottom:"8px"}),t}createErrorElement(e){const t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,n=document.createElement("div");n.className="floating-translation floating-error",Object.assign(n.style,{position:"fixed",zIndex:"10000",backgroundColor:t?"#dc2626":"#fee2e2",color:t?"#fef2f2":"#991b1b",padding:"12px 16px",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",maxWidth:"300px",minWidth:"200px",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',border:t?"1px solid #b91c1c":"1px solid #fecaca"});const o=document.createElement("div");return o.className="translation-text",o.textContent=e,Object.assign(o.style,{fontSize:"14px",lineHeight:"1.5",wordBreak:"break-word"}),n.appendChild(o),n}positionElement(e){if(!this.floatingElement)return;let{x:t,y:n}=e;t=Math.max(0,t),n=Math.max(0,n),t+=10,n+=10;const o=this.floatingElement.getBoundingClientRect();t+o.width>window.innerWidth&&(t=window.innerWidth-o.width-10),n+o.height>window.innerHeight&&(n=window.innerHeight-o.height-10),t=Math.max(0,t),n=Math.max(0,n),this.floatingElement.style.left=`${t}px`,this.floatingElement.style.top=`${n}px`}}const p="20px",m="20px",u="#4F46E5",E="#EF4444",y="#FFFFFF",C="rgba(0,0,0,0.1)",T="rgba(255,255,255,0.2)",w="#FFFFFF",S="16px 20px",f="280px",b="400px",x="8px",N="6px",R="system-ui, -apple-system, sans-serif",v="14px",A="500",M="0 4px 12px rgba(0, 0, 0, 0.15)",P="0 4px 12px rgba(0, 0, 0, 0.4)",L="fadeIn 0.3s ease",F="width 0.3s ease",O=3e3;class k{constructor(){this.container=null,this.progressBar=null,this.messageElement=null,this.autoHideTimer=null,this.currentPhase=null,this.isDarkMode=this.detectDarkMode(),s.log("ProgressNotification initialized",{isDarkMode:this.isDarkMode})}detectDarkMode(){return"undefined"!=typeof window&&(window.matchMedia?.("(prefers-color-scheme: dark)")?.matches??!1)}show(e){s.log("ProgressNotification.show() called",{total:e}),this.remove(),this.container=document.createElement("div"),this.container.className="progress-notification",this.applyContainerStyles(this.container,!1),this.messageElement=this.createMessageElement();const t=this.createProgressBarContainer();this.progressBar=this.createProgressBar(),t.appendChild(this.progressBar),this.container.appendChild(this.messageElement),this.container.appendChild(t),document.body.appendChild(this.container),s.log("ProgressNotification shown")}update(e,t){if(!this.container||!this.progressBar||!this.messageElement)return void s.warn("ProgressNotification.update() called but notification not shown");const n=t>0?Math.min(100,Math.round(e/t*100)):0;this.messageElement.textContent=`翻訳中... ${n}%`,this.progressBar.style.width=`${n}%`,s.log("ProgressNotification updated",{current:e,total:t,percentage:n})}updatePhase(e,t,n){if(!this.container||!this.progressBar)return void s.warn("ProgressNotification.updatePhase() called but notification not shown");let o;if(void 0!==n){if(this.currentPhase=e,o=n>0?Math.min(100,Math.round(t/n*100)):0,this.messageElement){const t=1===e?`ビューポート内を翻訳中... ${o}%`:`ページ全体を翻訳中... ${o}%`;this.messageElement.textContent=t}}else o=Math.max(0,Math.min(100,Math.round(t)));this.progressBar.style.width=`${o}%`,s.log("ProgressNotification phase updated",{phase:e,percentage:o})}complete(){this.container&&this.progressBar&&this.messageElement?(this.messageElement.textContent="翻訳完了 100%",this.progressBar.style.width="100%",this.autoHideTimer=setTimeout(()=>{this.remove()},O),s.log("ProgressNotification completed, will auto-hide in 3s")):s.warn("ProgressNotification.complete() called but notification not shown")}error(e){this.container&&this.messageElement||(s.warn("ProgressNotification.error() called but notification not shown"),this.show(0)),this.container&&this.messageElement&&(this.messageElement.textContent=`エラー: ${e}`,this.applyContainerStyles(this.container,!0),this.autoHideTimer&&(clearTimeout(this.autoHideTimer),this.autoHideTimer=null),s.error("ProgressNotification error displayed",{errorMessage:e}))}remove(){this.autoHideTimer&&(clearTimeout(this.autoHideTimer),this.autoHideTimer=null),document.querySelectorAll(".progress-notification").forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)}),this.container=null,this.progressBar=null,this.messageElement=null,s.log("ProgressNotification removed")}createMessageElement(){const e=document.createElement("div");return e.className="progress-message",e.textContent="翻訳を開始しています... 0%",e.style.marginBottom="8px",e.style.fontSize=v,e.style.fontWeight=A,e}createProgressBarContainer(){const e=document.createElement("div");return e.className="progress-bar-container",e.style.width="100%",e.style.height=N,e.style.backgroundColor=this.isDarkMode?T:C,e.style.borderRadius="3px",e.style.overflow="hidden",e}createProgressBar(){const e=document.createElement("div");return e.className="progress-bar",e.style.width="0%",e.style.height="100%",e.style.backgroundColor=w,e.style.transition=F,e.style.borderRadius="3px",e}applyContainerStyles(e,t){e.style.position="fixed",e.style.bottom=p,e.style.right=m,e.style.zIndex="10001",e.style.padding=S,e.style.borderRadius=x,e.style.minWidth=f,e.style.maxWidth=b,e.style.color=y,e.style.fontFamily=R,e.style.backgroundColor=t?E:u,e.style.boxShadow=this.isDarkMode?P:M,e.style.animation=L,this.injectAnimationStyles()}injectAnimationStyles(){if(!document.querySelector("#progress-notification-styles")){const e=document.createElement("style");e.id="progress-notification-styles",e.textContent="\n  @keyframes fadeIn {\n    from {\n      opacity: 0;\n      transform: translateY(10px);\n    }\n    to {\n      opacity: 1;\n      transform: translateY(0);\n    }\n  }\n",document.head.appendChild(e)}}showPhase(e,t){this.currentPhase=e,this.remove(),this.container=document.createElement("div"),this.container.className="progress-notification",this.applyContainerStyles(this.container,!1),this.messageElement=this.createMessageElement();const n=1===e?"ビューポート内を翻訳中... 0%":"ページ全体を翻訳中... 0%";this.messageElement.textContent=n;const o=this.createProgressBarContainer();this.progressBar=this.createProgressBar(),o.appendChild(this.progressBar),this.container.appendChild(this.messageElement),this.container.appendChild(o),document.body.appendChild(this.container),s.log(`ProgressNotification.showPhase(${e}, ${t}) called`)}completePhase(e){if(!this.container||!this.messageElement)return void s.warn("ProgressNotification.completePhase() called but notification not shown");const t=1===e?"ビューポート内の翻訳完了":"ページ全体の翻訳完了";this.messageElement.textContent=t,s.log(`ProgressNotification.completePhase(${e})`)}}class ${constructor(){this.isTranslated=!1,this.extractedNodes=[],this.currentTranslationNodes=[],this.domManipulator=new e,this.selectionHandler=new c,this.clipboardHandler=new d,this.mutationObserver=new g,this.floatingUI=new h,this.progressNotification=new k,this.messageBus=new n,s.log("ContentScript initialized")}initialize(){this.messageBus.listen(this.handleMessage.bind(this)),this.selectionHandler.enable(),s.log("ContentScript ready")}async handleMessage(e,t,n){const a=(new Date).toISOString();console.log(`[Content:ContentScript] ${a} - handleMessage() called:`,{messageType:e.type,payload:"payload"in e?e.payload:void 0}),s.log("ContentScript received message:",e.type);try{switch(e.type){case o.TRANSLATE_PAGE:console.log(`[Content:ContentScript] ${a} - Handling TRANSLATE_PAGE:`,{targetLanguage:"payload"in e?e.payload.targetLanguage:"en"}),await this.translatePage("payload"in e?e.payload.targetLanguage:"en"),console.log(`[Content:ContentScript] ${a} - TRANSLATE_PAGE completed successfully`),n({success:!0});break;case o.TRANSLATE_SELECTION:console.log(`[Content:ContentScript] ${a} - Handling TRANSLATE_SELECTION`),await this.translateSelection("payload"in e?e.payload.targetLanguage:"en"),console.log(`[Content:ContentScript] ${a} - TRANSLATE_SELECTION completed successfully`),n({success:!0});break;case o.TRANSLATE_CLIPBOARD:console.log(`[Content:ContentScript] ${a} - Handling TRANSLATE_CLIPBOARD`),await this.translateClipboard("payload"in e?e.payload.targetLanguage:"en"),console.log(`[Content:ContentScript] ${a} - TRANSLATE_CLIPBOARD completed successfully`),n({success:!0});break;case o.RESET:console.log(`[Content:ContentScript] ${a} - Handling RESET`),this.reset(),console.log(`[Content:ContentScript] ${a} - RESET completed successfully`),n({success:!0});break;case o.TRANSLATION_PROGRESS:if(console.log(`[Content:ContentScript] ${a} - Handling TRANSLATION_PROGRESS`),"payload"in e&&e.payload){const{current:t,total:n}=e.payload;"number"==typeof t&&"number"==typeof n&&this.progressNotification.update(t,n)}n({success:!0});break;case o.TRANSLATION_ERROR:console.log(`[Content:ContentScript] ${a} - Handling TRANSLATION_ERROR`),"payload"in e&&e.payload&&void 0!==e.payload.error&&(this.progressNotification.error(e.payload.error),s.error("Translation error received:",e.payload.error)),n({success:!0});break;case o.BATCH_COMPLETED:console.log(`[Content:ContentScript] ${a} - Handling BATCH_COMPLETED`),"payload"in e&&e.payload&&this.handleBatchCompleted(e.payload),n({success:!0});break;default:console.warn(`[Content:ContentScript] ${a} - Unknown message type:`,e.type),s.log("Unknown message type:",e.type),n({success:!1,error:"Unknown message type"})}}catch(e){console.error(`[Content:ContentScript] ${a} - Error handling message:`,{error:e,message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),s.error("Error handling message:",e),n({success:!1,error:String(e)})}}async translatePage(e){const t=(new Date).toISOString();console.log(`[Content:ContentScript] ${t} - translatePage() called:`,{targetLanguage:e});try{if(s.log("Translating page to",e),console.log(`[Content:ContentScript] ${t} - Extracting text nodes from DOM...`),this.extractedNodes=this.domManipulator.extractTextNodes(),console.log(`[Content:ContentScript] ${t} - Text nodes extracted:`,{count:this.extractedNodes.length}),0===this.extractedNodes.length)return console.warn(`[Content:ContentScript] ${t} - No text nodes to translate`),void s.log("No text nodes to translate");console.log(`[Content:ContentScript] ${t} - Detecting viewport nodes...`);const{viewport:n,outOfViewport:a}=this.domManipulator.detectViewportNodes(this.extractedNodes);if(console.log(`[Content:ContentScript] ${t} - Viewport detection completed:`,{viewportCount:n.length,outOfViewportCount:a.length}),n.length>0){console.log(`[Content:ContentScript] ${t} - Starting Phase 1: Viewport translation`),this.progressNotification.showPhase(1,n.length),this.currentTranslationNodes=n;const a=n.map(e=>e.text);console.log(`[Content:ContentScript] ${t} - Sending Phase 1 REQUEST_TRANSLATION:`,{type:o.REQUEST_TRANSLATION,action:"requestTranslation",textsCount:a.length,targetLanguage:e,semiParallel:!0,priorityCount:1,phase:1});const s=await this.messageBus.send({type:o.REQUEST_TRANSLATION,action:"requestTranslation",payload:{texts:a,targetLanguage:e,semiParallel:!0,priorityCount:1,phase:1}});console.log(`[Content:ContentScript] ${t} - Phase 1 response received:`,{success:s?.success,hasTranslations:!!s?.data?.translations}),s?.success&&s?.data?.translations?(console.log(`[Content:ContentScript] ${t} - Phase 1 completed`),this.progressNotification.completePhase(1)):console.warn(`[Content:ContentScript] ${t} - Phase 1 failed:`,s),console.log(`[Content:ContentScript] ${t} - Phase 1 request completed (batches were applied via BATCH_COMPLETED)`)}else console.log(`[Content:ContentScript] ${t} - Phase 1 skipped: No viewport nodes`);if(a.length>0){console.log(`[Content:ContentScript] ${t} - Starting Phase 2: Full-page translation`),this.progressNotification.showPhase(2,a.length);const n=a.map(e=>e.text);console.log(`[Content:ContentScript] ${t} - Sending Phase 2 REQUEST_TRANSLATION:`,{type:o.REQUEST_TRANSLATION,action:"requestTranslation",textsCount:n.length,targetLanguage:e,semiParallel:!1});const s=await this.messageBus.send({type:o.REQUEST_TRANSLATION,action:"requestTranslation",payload:{texts:n,targetLanguage:e,semiParallel:!1}});console.log(`[Content:ContentScript] ${t} - Phase 2 response received:`,{success:s?.success,hasTranslations:!!s?.data?.translations}),s?.success&&s?.data?.translations?(console.log(`[Content:ContentScript] ${t} - Applying Phase 2 translations`),this.domManipulator.applyTranslations(a,s.data.translations),this.progressNotification.completePhase(2),console.log(`[Content:ContentScript] ${t} - Phase 2 completed`)):console.warn(`[Content:ContentScript] ${t} - Phase 2 failed:`,s)}else console.log(`[Content:ContentScript] ${t} - Phase 2 skipped: No out-of-viewport nodes`);this.isTranslated=!0,this.progressNotification.complete(),console.log(`[Content:ContentScript] ${t} - Page translation completed successfully`),s.log("Page translation completed")}catch(e){throw console.error(`[Content:ContentScript] ${t} - Failed to translate page:`,{error:e,message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),s.error("Failed to translate page:",e),this.progressNotification.error(e instanceof Error?e.message:"Translation failed"),e}}async translateSelection(e){try{const t=await this.selectionHandler.translateSelection(e);if(t){const e=window.getSelection();if(e&&e.rangeCount>0){const n=e.getRangeAt(0).getBoundingClientRect();this.floatingUI.show(t,{x:n.left+window.scrollX,y:n.bottom+window.scrollY}),s.log("Selection translation displayed")}}else s.log("No selection to translate")}catch(e){throw s.error("Failed to translate selection:",e),e}}async translateClipboard(e){try{const t=await this.clipboardHandler.translateClipboard(e);t?(this.floatingUI.show(t,{x:window.innerWidth/2-200,y:window.innerHeight/2-100}),s.log("Clipboard translation displayed")):s.log("No clipboard content to translate")}catch(e){throw s.error("Failed to translate clipboard:",e),e}}reset(){try{this.domManipulator.reset(),this.floatingUI.hide(),this.isTranslated=!1,s.log("Page reset to original state")}catch(e){throw s.error("Failed to reset page:",e),e}}enableDynamicTranslation(e){this.mutationObserver.observe(async t=>{t.some(e=>Array.from(e.addedNodes).some(e=>e.nodeType===Node.TEXT_NODE))&&this.isTranslated&&(s.log("Dynamic content detected, re-translating"),await this.translatePage(e))}),s.log("Dynamic translation enabled")}disableDynamicTranslation(){this.mutationObserver.disconnect(),s.log("Dynamic translation disabled")}handleBatchCompleted(e){const t=(new Date).toISOString();console.log(`[Content:ContentScript] ${t} - handleBatchCompleted() called:`,e);try{const{translations:n,nodeIndices:o,phase:a,progress:i}=e;if(!this.currentTranslationNodes||0===this.currentTranslationNodes.length)return void console.warn(`[Content:ContentScript] ${t} - currentTranslationNodes is empty, skipping batch application`);const r=o.filter(e=>e<this.currentTranslationNodes.length).map(e=>this.currentTranslationNodes[e]);r.length!==n.length&&console.warn(`[Content:ContentScript] ${t} - Mismatch: nodes(${r.length}) vs translations(${n.length})`),console.log(`[Content:ContentScript] ${t} - Applying batch translations:`,{nodesCount:r.length,translationsCount:n.length,phase:a,progress:i}),this.domManipulator.applyTranslations(r,n),"number"==typeof i?.percentage&&this.progressNotification.updatePhase(a,i.percentage),console.log(`[Content:ContentScript] ${t} - Batch applied successfully:`,`Progress: ${i.current}/${i.total} (${i.percentage}%)`),s.log(`Batch ${e.batchIndex} completed: ${n.length} texts translated`)}catch(e){console.error(`[Content:ContentScript] ${t} - Failed to handle batch completed:`,{error:e,message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),s.error("Failed to handle batch completed:",e)}}cleanup(){this.selectionHandler.disable(),this.mutationObserver.disconnect(),this.floatingUI.hide(),this.progressNotification.remove(),s.log("ContentScript cleaned up")}}"undefined"!=typeof chrome&&chrome.runtime?chrome:window.browser;let I=null;try{I=new $,I.initialize(),s.log("DoganayLab Translate - Content Script initialized")}catch(e){s.error("Failed to initialize content script:",e)}window.addEventListener("beforeunload",()=>{I&&I.cleanup()})})();