(()=>{"use strict";class e{constructor(){this.originalTextMap=new WeakMap,this.IGNORED_TAGS=["SCRIPT","STYLE","NOSCRIPT","IFRAME"]}extractTextNodes(){const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:e=>{const t=e.parentElement;return t?this.IGNORED_TAGS.includes(t.tagName)?NodeFilter.FILTER_REJECT:e.textContent?.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT:NodeFilter.FILTER_REJECT}}),t=[];let n,o=0;for(;n=e.nextNode();){const e=n.textContent||"";this.saveOriginalText(n),t.push({node:n,text:e,index:o}),o++}return t}applyTranslations(e,t){e.forEach((e,n)=>{t[n]&&t[n].trim()&&(e.node.textContent=t[n])})}reset(){const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT);let t;for(;t=e.nextNode();){const e=this.originalTextMap.get(t);void 0!==e&&(t.textContent=e)}}saveOriginalText(e){this.originalTextMap.has(e)||this.originalTextMap.set(e,e.textContent||"")}}const t=new class{constructor(){this.api="undefined"!=typeof chrome&&chrome.runtime?chrome:browser}handleRuntimeError(e,t,n){this.api.runtime.lastError?t(new Error(this.api.runtime.lastError.message)):e(n)}get isChrome(){return"undefined"!=typeof chrome&&!!chrome.runtime}get isFirefox(){return!this.isChrome&&"undefined"!=typeof browser&&!!browser.runtime}get manifestVersion(){return this.api.runtime.getManifest().manifest_version}get storage(){return{get:e=>new Promise((t,n)=>{this.api.storage.local.get(e,e=>{this.handleRuntimeError(t,n,e)})}),set:e=>new Promise((t,n)=>{this.api.storage.local.set(e,()=>{this.handleRuntimeError(t,n,void 0)})}),remove:e=>new Promise((t,n)=>{this.api.storage.local.remove(e,()=>{this.handleRuntimeError(t,n,void 0)})})}}get runtime(){return{sendMessage:e=>new Promise(t=>{this.api.runtime.sendMessage(e,e=>{t(e)})}),onMessage:this.api.runtime.onMessage,getManifest:()=>this.api.runtime.getManifest(),openOptionsPage:()=>this.api.runtime.openOptionsPage()}}get tabs(){return{query:e=>new Promise(t=>{this.api.tabs.query(e,t)}),sendMessage:(e,t)=>new Promise(n=>{this.api.tabs.sendMessage(e,t,e=>{n(e)})})}}get commands(){return{onCommand:this.api.commands.onCommand}}};class n{constructor(){this.listeners=new Map}async send(e){const n={...e,timestamp:e.timestamp||Date.now()};return t.runtime.sendMessage(n)}async sendToTab(e,n){const o={...n,timestamp:n.timestamp||Date.now()};return t.tabs.sendMessage(e,o)}listen(e,n){const o=(t,o,s)=>(!n||t.type===n)&&(e(t,o,s)||!1);this.listeners.set(e,o),t.runtime.onMessage.addListener(o)}unlisten(e){const n=this.listeners.get(e);n&&(t.runtime.onMessage.removeListener(n),this.listeners.delete(e))}}var o;function s(e){return`${function(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:${String(e.getSeconds()).padStart(2,"0")}`}()} [${e}]`}new n,function(e){e.TRANSLATE_PAGE="translate",e.TRANSLATE_SELECTION="translateSelection",e.TRANSLATE_CLIPBOARD="translateClipboard",e.REQUEST_TRANSLATION="requestTranslation",e.RESET="reset",e.TRANSLATION_STARTED="translationStarted",e.TRANSLATION_PROGRESS="translationProgress",e.TRANSLATION_COMPLETED="translationCompleted",e.TRANSLATION_ERROR="translationError",e.SETTINGS_CHANGED="settingsChanged",e.API_KEY_UPDATED="apiKeyUpdated",e.RELOAD_CONFIG="reloadConfig",e.TEST_CONNECTION="testConnection"}(o||(o={}));const a={log(e,...t){},warn(e,...t){const n=s("WARN");console.warn(`${n} ${e}`,...t)},error(e,...t){const n=s("ERROR");console.error(`${n} ${e}`,...t)}};class r{constructor(){this.enabled=!1,this.mouseUpHandler=null,this.messageBus=new n}enable(){this.enabled||(this.mouseUpHandler=this.handleMouseUp.bind(this),document.addEventListener("mouseup",this.mouseUpHandler),this.enabled=!0,a.log("SelectionHandler enabled"))}disable(){this.enabled&&this.mouseUpHandler&&(document.removeEventListener("mouseup",this.mouseUpHandler),this.mouseUpHandler=null,this.enabled=!1,a.log("SelectionHandler disabled"))}getSelectedText(){const e=window.getSelection();if(!e||0===e.rangeCount)return null;return e.toString().trim()||null}async translateSelection(e){const t=this.getSelectedText();if(!t)return a.log("No text selected for translation"),null;try{a.log("Translating selection:",t.substring(0,50));const n=await this.messageBus.send({type:o.REQUEST_TRANSLATION,action:"requestTranslation",payload:{texts:[t],targetLanguage:e}});return n?.success&&n?.data?.translations&&n.data.translations.length>0?n.data.translations[0]:(a.warn("Empty translation response"),null)}catch(e){return a.error("Failed to translate selection:",e),null}}handleMouseUp(e){setTimeout(()=>{const e=this.getSelectedText();e&&a.log("Text selected:",e.substring(0,50))},10)}}class i{constructor(){this.messageBus=new n}async read(){try{if(!navigator.clipboard||!navigator.clipboard.readText)return a.warn("Clipboard API not available"),null;const e=(await navigator.clipboard.readText()).trim();return e?(a.log("Clipboard read:",e.substring(0,50)),e):(a.log("Clipboard is empty"),null)}catch(e){return a.error("Failed to read clipboard:",e),null}}async translateClipboard(e){try{const t=await this.read();if(!t)return a.log("No clipboard text to translate"),null;a.log("Translating clipboard content to",e);const n=await this.messageBus.send({type:o.REQUEST_TRANSLATION,action:"requestTranslation",payload:{texts:[t],targetLanguage:e}});return n?.success&&n?.data?.translations&&n.data.translations.length>0?n.data.translations[0]:(a.warn("Empty translation response for clipboard"),null)}catch(e){return a.error("Failed to translate clipboard:",e),null}}}class l{constructor(){this.observer=null,this.callback=null,this.isObserving=!1}observe(e){this.isObserving?a.log("MutationObserver already observing"):(this.callback=e,this.observer=new MutationObserver(e=>{try{this.callback&&this.callback(e)}catch(e){a.error("Error in MutationObserver callback:",e)}}),this.observer.observe(document.body,{childList:!0,subtree:!0}),this.isObserving=!0,a.log("MutationObserver started"))}disconnect(){this.isObserving&&this.observer&&(this.observer.disconnect(),this.observer=null,this.callback=null,this.isObserving=!1,a.log("MutationObserver disconnected"))}}new Map([{code:"en",name:"English",nameEn:"English"},{code:"ja",name:"日本語",nameEn:"Japanese"},{code:"zh",name:"中文",nameEn:"Chinese (Simplified)"},{code:"zh-TW",name:"中文 (繁體)",nameEn:"Chinese (Traditional)"},{code:"ko",name:"한국어",nameEn:"Korean"},{code:"es",name:"Español",nameEn:"Spanish"},{code:"fr",name:"Français",nameEn:"French"},{code:"de",name:"Deutsch",nameEn:"German"},{code:"it",name:"Italiano",nameEn:"Italian"},{code:"pt",name:"Português",nameEn:"Portuguese"},{code:"ru",name:"Русский",nameEn:"Russian"},{code:"ar",name:"العربية",nameEn:"Arabic"},{code:"hi",name:"हिन्दी",nameEn:"Hindi"},{code:"th",name:"ไทย",nameEn:"Thai"},{code:"vi",name:"Tiếng Việt",nameEn:"Vietnamese"},{code:"id",name:"Bahasa Indonesia",nameEn:"Indonesian"},{code:"tr",name:"Türkçe",nameEn:"Turkish"},{code:"pl",name:"Polski",nameEn:"Polish"},{code:"nl",name:"Nederlands",nameEn:"Dutch"},{code:"sv",name:"Svenska",nameEn:"Swedish"}].map(e=>[e.code,e]));class c{constructor(){this.floatingElement=null,this.translation=""}show(e,t){this.hide(),this.translation=e,this.floatingElement=this.createFloatingElement();const n=this.createTextElement(e);this.floatingElement.appendChild(n);const o=this.createCopyButton();this.floatingElement.appendChild(o),document.body.appendChild(this.floatingElement),this.positionElement(t),a.log("FloatingUI shown at",t)}hide(){this.floatingElement&&this.floatingElement.parentNode&&(this.floatingElement.parentNode.removeChild(this.floatingElement),this.floatingElement=null,a.log("FloatingUI hidden"))}createCopyButton(){const e=document.createElement("button");return e.className="copy-button",e.textContent="Copy",e.type="button",Object.assign(e.style,{marginTop:"8px",padding:"6px 12px",backgroundColor:"#4F46E5",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"14px",fontWeight:"500"}),e.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(this.translation),e.textContent="Copied!",e.style.backgroundColor="#10B981",setTimeout(()=>{e.textContent="Copy",e.style.backgroundColor="#4F46E5"},2e3),a.log("Translation copied to clipboard")}catch(t){a.error("Failed to copy to clipboard:",t),e.textContent="Error",e.style.backgroundColor="#EF4444",setTimeout(()=>{e.textContent="Copy",e.style.backgroundColor="#4F46E5"},2e3)}}),e}createFloatingElement(){const e=document.createElement("div");e.className="floating-translation";const t=window.matchMedia("(prefers-color-scheme: dark)").matches;return Object.assign(e.style,{position:"fixed",zIndex:"10000",backgroundColor:t?"#1F2937":"#FFFFFF",color:t?"#F3F4F6":"#1F2937",padding:"16px",borderRadius:"8px",boxShadow:"0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)",maxWidth:"400px",minWidth:"200px",display:"flex",flexDirection:"column",border:t?"1px solid #374151":"1px solid #E5E7EB"}),e}createTextElement(e){const t=document.createElement("div");return t.className="translation-text",t.textContent=e,Object.assign(t.style,{fontSize:"14px",lineHeight:"1.5",wordBreak:"break-word",marginBottom:"8px"}),t}positionElement(e){if(!this.floatingElement)return;let{x:t,y:n}=e;t=Math.max(0,t),n=Math.max(0,n),t+=10,n+=10;const o=this.floatingElement.getBoundingClientRect();t+o.width>window.innerWidth&&(t=window.innerWidth-o.width-10),n+o.height>window.innerHeight&&(n=window.innerHeight-o.height-10),t=Math.max(0,t),n=Math.max(0,n),this.floatingElement.style.left=`${t}px`,this.floatingElement.style.top=`${n}px`}}const d="20px",g="20px",h="#4F46E5",p="#EF4444",m="#FFFFFF",u="rgba(0,0,0,0.1)",E="rgba(255,255,255,0.2)",y="#FFFFFF",T="16px 20px",C="280px",b="400px",S="8px",f="6px",w="system-ui, -apple-system, sans-serif",x="14px",N="500",R="0 4px 12px rgba(0, 0, 0, 0.15)",A="0 4px 12px rgba(0, 0, 0, 0.4)",v="fadeIn 0.3s ease",O="width 0.3s ease",F=3e3;class L{constructor(){this.container=null,this.progressBar=null,this.messageElement=null,this.autoHideTimer=null,this.isDarkMode=this.detectDarkMode(),a.log("ProgressNotification initialized",{isDarkMode:this.isDarkMode})}detectDarkMode(){return"undefined"!=typeof window&&(window.matchMedia?.("(prefers-color-scheme: dark)")?.matches??!1)}show(e){a.log("ProgressNotification.show() called",{total:e}),this.remove(),this.container=document.createElement("div"),this.container.className="progress-notification",this.applyContainerStyles(this.container,!1),this.messageElement=this.createMessageElement();const t=this.createProgressBarContainer();this.progressBar=this.createProgressBar(),t.appendChild(this.progressBar),this.container.appendChild(this.messageElement),this.container.appendChild(t),document.body.appendChild(this.container),a.log("ProgressNotification shown")}update(e,t){if(!this.container||!this.progressBar||!this.messageElement)return void a.warn("ProgressNotification.update() called but notification not shown");const n=t>0?Math.min(100,Math.round(e/t*100)):0;this.messageElement.textContent=`翻訳中... ${n}%`,this.progressBar.style.width=`${n}%`,a.log("ProgressNotification updated",{current:e,total:t,percentage:n})}complete(){this.container&&this.progressBar&&this.messageElement?(this.messageElement.textContent="翻訳完了 100%",this.progressBar.style.width="100%",this.autoHideTimer=setTimeout(()=>{this.remove()},F),a.log("ProgressNotification completed, will auto-hide in 3s")):a.warn("ProgressNotification.complete() called but notification not shown")}error(e){this.container&&this.messageElement||(a.warn("ProgressNotification.error() called but notification not shown"),this.show(0)),this.container&&this.messageElement&&(this.messageElement.textContent=`エラー: ${e}`,this.applyContainerStyles(this.container,!0),this.autoHideTimer&&(clearTimeout(this.autoHideTimer),this.autoHideTimer=null),a.error("ProgressNotification error displayed",{errorMessage:e}))}remove(){this.autoHideTimer&&(clearTimeout(this.autoHideTimer),this.autoHideTimer=null),document.querySelectorAll(".progress-notification").forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)}),this.container=null,this.progressBar=null,this.messageElement=null,a.log("ProgressNotification removed")}createMessageElement(){const e=document.createElement("div");return e.className="progress-message",e.textContent="翻訳を開始しています... 0%",e.style.marginBottom="8px",e.style.fontSize=x,e.style.fontWeight=N,e}createProgressBarContainer(){const e=document.createElement("div");return e.className="progress-bar-container",e.style.width="100%",e.style.height=f,e.style.backgroundColor=this.isDarkMode?E:u,e.style.borderRadius="3px",e.style.overflow="hidden",e}createProgressBar(){const e=document.createElement("div");return e.className="progress-bar",e.style.width="0%",e.style.height="100%",e.style.backgroundColor=y,e.style.transition=O,e.style.borderRadius="3px",e}applyContainerStyles(e,t){e.style.position="fixed",e.style.bottom=d,e.style.right=g,e.style.zIndex="10001",e.style.padding=T,e.style.borderRadius=S,e.style.minWidth=C,e.style.maxWidth=b,e.style.color=m,e.style.fontFamily=w,e.style.backgroundColor=t?p:h,e.style.boxShadow=this.isDarkMode?A:R,e.style.animation=v,this.injectAnimationStyles()}injectAnimationStyles(){if(!document.querySelector("#progress-notification-styles")){const e=document.createElement("style");e.id="progress-notification-styles",e.textContent="\n  @keyframes fadeIn {\n    from {\n      opacity: 0;\n      transform: translateY(10px);\n    }\n    to {\n      opacity: 1;\n      transform: translateY(0);\n    }\n  }\n",document.head.appendChild(e)}}}class M{constructor(){this.isTranslated=!1,this.extractedNodes=[],this.domManipulator=new e,this.selectionHandler=new r,this.clipboardHandler=new i,this.mutationObserver=new l,this.floatingUI=new c,this.progressNotification=new L,this.messageBus=new n,a.log("ContentScript initialized")}initialize(){this.messageBus.listen(this.handleMessage.bind(this)),this.selectionHandler.enable(),a.log("ContentScript ready")}async handleMessage(e,t,n){const s=(new Date).toISOString();console.log(`[Content:ContentScript] ${s} - handleMessage() called:`,{messageType:e.type,payload:"payload"in e?e.payload:void 0}),a.log("ContentScript received message:",e.type);try{switch(e.type){case o.TRANSLATE_PAGE:console.log(`[Content:ContentScript] ${s} - Handling TRANSLATE_PAGE:`,{targetLanguage:"payload"in e?e.payload.targetLanguage:"en"}),await this.translatePage("payload"in e?e.payload.targetLanguage:"en"),console.log(`[Content:ContentScript] ${s} - TRANSLATE_PAGE completed successfully`),n({success:!0});break;case o.TRANSLATE_SELECTION:console.log(`[Content:ContentScript] ${s} - Handling TRANSLATE_SELECTION`),await this.translateSelection("payload"in e?e.payload.targetLanguage:"en"),console.log(`[Content:ContentScript] ${s} - TRANSLATE_SELECTION completed successfully`),n({success:!0});break;case o.TRANSLATE_CLIPBOARD:console.log(`[Content:ContentScript] ${s} - Handling TRANSLATE_CLIPBOARD`),await this.translateClipboard("payload"in e?e.payload.targetLanguage:"en"),console.log(`[Content:ContentScript] ${s} - TRANSLATE_CLIPBOARD completed successfully`),n({success:!0});break;case o.RESET:console.log(`[Content:ContentScript] ${s} - Handling RESET`),this.reset(),console.log(`[Content:ContentScript] ${s} - RESET completed successfully`),n({success:!0});break;case o.TRANSLATION_PROGRESS:if(console.log(`[Content:ContentScript] ${s} - Handling TRANSLATION_PROGRESS`),"payload"in e&&e.payload){const{current:t,total:n}=e.payload;"number"==typeof t&&"number"==typeof n&&this.progressNotification.update(t,n)}n({success:!0});break;case o.TRANSLATION_ERROR:console.log(`[Content:ContentScript] ${s} - Handling TRANSLATION_ERROR`),"payload"in e&&e.payload&&void 0!==e.payload.error&&(this.progressNotification.error(e.payload.error),a.error("Translation error received:",e.payload.error)),n({success:!0});break;default:console.warn(`[Content:ContentScript] ${s} - Unknown message type:`,e.type),a.log("Unknown message type:",e.type),n({success:!1,error:"Unknown message type"})}}catch(e){console.error(`[Content:ContentScript] ${s} - Error handling message:`,{error:e,message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),a.error("Error handling message:",e),n({success:!1,error:String(e)})}}async translatePage(e){const t=(new Date).toISOString();console.log(`[Content:ContentScript] ${t} - translatePage() called:`,{targetLanguage:e});try{if(a.log("Translating page to",e),console.log(`[Content:ContentScript] ${t} - Extracting text nodes from DOM...`),this.extractedNodes=this.domManipulator.extractTextNodes(),console.log(`[Content:ContentScript] ${t} - Text nodes extracted:`,{count:this.extractedNodes.length}),0===this.extractedNodes.length)return console.warn(`[Content:ContentScript] ${t} - No text nodes to translate`),void a.log("No text nodes to translate");this.progressNotification.show(this.extractedNodes.length);const n=this.extractedNodes.map(e=>e.text);console.log(`[Content:ContentScript] ${t} - Prepared texts for translation:`,{count:n.length,firstText:n[0]?.substring(0,50)}),a.log(`Extracted ${n.length} text nodes`),console.log(`[Content:ContentScript] ${t} - Sending REQUEST_TRANSLATION to background:`,{type:o.REQUEST_TRANSLATION,action:"requestTranslation",textsCount:n.length,targetLanguage:e});const s=await this.messageBus.send({type:o.REQUEST_TRANSLATION,action:"requestTranslation",payload:{texts:n,targetLanguage:e}});if(console.log(`[Content:ContentScript] ${t} - Received response from background:`,{response:s,success:s?.success,hasData:!!s?.data,hasTranslations:!!s?.data?.translations}),s?.success&&s?.data?.translations){const e=s.data.translations;console.log(`[Content:ContentScript] ${t} - Applying translations to DOM:`,{translationsCount:e.length,firstTranslation:e[0]?.substring(0,50)}),this.domManipulator.applyTranslations(this.extractedNodes,e),this.isTranslated=!0,this.progressNotification.complete(),console.log(`[Content:ContentScript] ${t} - Page translation completed successfully`),a.log("Page translation completed")}else console.warn(`[Content:ContentScript] ${t} - No translations received in response:`,s),a.warn("No translations received")}catch(e){throw console.error(`[Content:ContentScript] ${t} - Failed to translate page:`,{error:e,message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),a.error("Failed to translate page:",e),this.progressNotification.error(e instanceof Error?e.message:"Translation failed"),e}}async translateSelection(e){try{const t=await this.selectionHandler.translateSelection(e);if(t){const e=window.getSelection();if(e&&e.rangeCount>0){const n=e.getRangeAt(0).getBoundingClientRect();this.floatingUI.show(t,{x:n.left+window.scrollX,y:n.bottom+window.scrollY}),a.log("Selection translation displayed")}}else a.log("No selection to translate")}catch(e){throw a.error("Failed to translate selection:",e),e}}async translateClipboard(e){try{const t=await this.clipboardHandler.translateClipboard(e);t?(this.floatingUI.show(t,{x:window.innerWidth/2-200,y:window.innerHeight/2-100}),a.log("Clipboard translation displayed")):a.log("No clipboard content to translate")}catch(e){throw a.error("Failed to translate clipboard:",e),e}}reset(){try{this.domManipulator.reset(),this.floatingUI.hide(),this.isTranslated=!1,a.log("Page reset to original state")}catch(e){throw a.error("Failed to reset page:",e),e}}enableDynamicTranslation(e){this.mutationObserver.observe(async t=>{t.some(e=>Array.from(e.addedNodes).some(e=>e.nodeType===Node.TEXT_NODE))&&this.isTranslated&&(a.log("Dynamic content detected, re-translating"),await this.translatePage(e))}),a.log("Dynamic translation enabled")}disableDynamicTranslation(){this.mutationObserver.disconnect(),a.log("Dynamic translation disabled")}cleanup(){this.selectionHandler.disable(),this.mutationObserver.disconnect(),this.floatingUI.hide(),this.progressNotification.remove(),a.log("ContentScript cleaned up")}}"undefined"!=typeof chrome&&chrome.runtime?chrome:window.browser;let k=null;try{k=new M,k.initialize(),a.log("DoganayLab Translate - Content Script initialized")}catch(e){a.error("Failed to initialize content script:",e)}window.addEventListener("beforeunload",()=>{k&&k.cleanup()})})();