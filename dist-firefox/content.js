(()=>{"use strict";class e{constructor(){this.originalTextMap=new WeakMap,this.IGNORED_TAGS=["SCRIPT","STYLE","NOSCRIPT","IFRAME"]}extractTextNodes(){const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:e=>{const t=e.parentElement;return t?this.IGNORED_TAGS.includes(t.tagName)?NodeFilter.FILTER_REJECT:e.textContent?.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT:NodeFilter.FILTER_REJECT}}),t=[];let n,a=0;for(;n=e.nextNode();){const e=n.textContent||"";this.saveOriginalText(n),t.push({node:n,text:e,index:a}),a++}return t}applyTranslations(e,t){e.forEach((e,n)=>{t[n]&&t[n].trim()&&(e.node.textContent=t[n])})}reset(){const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT);let t;for(;t=e.nextNode();){const e=this.originalTextMap.get(t);void 0!==e&&(t.textContent=e)}}saveOriginalText(e){this.originalTextMap.has(e)||this.originalTextMap.set(e,e.textContent||"")}}const t=new class{constructor(){this.api="undefined"!=typeof chrome&&chrome.runtime?chrome:browser}handleRuntimeError(e,t,n){this.api.runtime.lastError?t(new Error(this.api.runtime.lastError.message)):e(n)}get isChrome(){return"undefined"!=typeof chrome&&!!chrome.runtime}get isFirefox(){return!this.isChrome&&"undefined"!=typeof browser&&!!browser.runtime}get manifestVersion(){return this.api.runtime.getManifest().manifest_version}get storage(){return{get:e=>new Promise((t,n)=>{this.api.storage.local.get(e,e=>{this.handleRuntimeError(t,n,e)})}),set:e=>new Promise((t,n)=>{this.api.storage.local.set(e,()=>{this.handleRuntimeError(t,n,void 0)})}),remove:e=>new Promise((t,n)=>{this.api.storage.local.remove(e,()=>{this.handleRuntimeError(t,n,void 0)})})}}get runtime(){return{sendMessage:e=>new Promise(t=>{this.api.runtime.sendMessage(e,e=>{t(e)})}),onMessage:this.api.runtime.onMessage,getManifest:()=>this.api.runtime.getManifest(),openOptionsPage:()=>this.api.runtime.openOptionsPage()}}get tabs(){return{query:e=>new Promise(t=>{this.api.tabs.query(e,t)}),sendMessage:(e,t)=>new Promise(n=>{this.api.tabs.sendMessage(e,t,e=>{n(e)})})}}get commands(){return{onCommand:this.api.commands.onCommand}}};class n{constructor(){this.listeners=new Map}async send(e){const n={...e,timestamp:e.timestamp||Date.now()};return t.runtime.sendMessage(n)}async sendToTab(e,n){const a={...n,timestamp:n.timestamp||Date.now()};return t.tabs.sendMessage(e,a)}listen(e,n){const a=(t,a,o)=>(!n||t.type===n)&&(e(t,a,o)||!1);this.listeners.set(e,a),t.runtime.onMessage.addListener(a)}unlisten(e){const n=this.listeners.get(e);n&&(t.runtime.onMessage.removeListener(n),this.listeners.delete(e))}}var a;function o(e){return`${function(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:${String(e.getSeconds()).padStart(2,"0")}`}()} [${e}]`}new n,function(e){e.TRANSLATE_PAGE="translate",e.TRANSLATE_SELECTION="translateSelection",e.TRANSLATE_CLIPBOARD="translateClipboard",e.REQUEST_TRANSLATION="requestTranslation",e.RESET="reset",e.TRANSLATION_STARTED="translationStarted",e.TRANSLATION_PROGRESS="translationProgress",e.TRANSLATION_COMPLETED="translationCompleted",e.TRANSLATION_ERROR="translationError",e.SETTINGS_CHANGED="settingsChanged",e.API_KEY_UPDATED="apiKeyUpdated",e.TEST_CONNECTION="testConnection"}(a||(a={}));const s={log(e,...t){},warn(e,...t){const n=o("WARN");console.warn(`${n} ${e}`,...t)},error(e,...t){const n=o("ERROR");console.error(`${n} ${e}`,...t)}};class r{constructor(){this.enabled=!1,this.mouseUpHandler=null,this.messageBus=new n}enable(){this.enabled||(this.mouseUpHandler=this.handleMouseUp.bind(this),document.addEventListener("mouseup",this.mouseUpHandler),this.enabled=!0,s.log("SelectionHandler enabled"))}disable(){this.enabled&&this.mouseUpHandler&&(document.removeEventListener("mouseup",this.mouseUpHandler),this.mouseUpHandler=null,this.enabled=!1,s.log("SelectionHandler disabled"))}getSelectedText(){const e=window.getSelection();if(!e||0===e.rangeCount)return null;return e.toString().trim()||null}async translateSelection(e){const t=this.getSelectedText();if(!t)return s.log("No text selected for translation"),null;try{s.log("Translating selection:",t.substring(0,50));const n=await this.messageBus.send({type:a.REQUEST_TRANSLATION,action:"requestTranslation",payload:{texts:[t],targetLanguage:e}});return n?.success&&n?.data?.translations&&n.data.translations.length>0?n.data.translations[0]:(s.warn("Empty translation response"),null)}catch(e){return s.error("Failed to translate selection:",e),null}}handleMouseUp(e){setTimeout(()=>{const e=this.getSelectedText();e&&s.log("Text selected:",e.substring(0,50))},10)}}class i{constructor(){this.messageBus=new n}async read(){try{if(!navigator.clipboard||!navigator.clipboard.readText)return s.warn("Clipboard API not available"),null;const e=(await navigator.clipboard.readText()).trim();return e?(s.log("Clipboard read:",e.substring(0,50)),e):(s.log("Clipboard is empty"),null)}catch(e){return s.error("Failed to read clipboard:",e),null}}async translateClipboard(e){try{const t=await this.read();if(!t)return s.log("No clipboard text to translate"),null;s.log("Translating clipboard content to",e);const n=await this.messageBus.send({type:a.REQUEST_TRANSLATION,action:"requestTranslation",payload:{texts:[t],targetLanguage:e}});return n?.success&&n?.data?.translations&&n.data.translations.length>0?n.data.translations[0]:(s.warn("Empty translation response for clipboard"),null)}catch(e){return s.error("Failed to translate clipboard:",e),null}}}class l{constructor(){this.observer=null,this.callback=null,this.isObserving=!1}observe(e){this.isObserving?s.log("MutationObserver already observing"):(this.callback=e,this.observer=new MutationObserver(e=>{try{this.callback&&this.callback(e)}catch(e){s.error("Error in MutationObserver callback:",e)}}),this.observer.observe(document.body,{childList:!0,subtree:!0}),this.isObserving=!0,s.log("MutationObserver started"))}disconnect(){this.isObserving&&this.observer&&(this.observer.disconnect(),this.observer=null,this.callback=null,this.isObserving=!1,s.log("MutationObserver disconnected"))}}new Map([{code:"en",name:"English",nameEn:"English"},{code:"ja",name:"日本語",nameEn:"Japanese"},{code:"zh",name:"中文",nameEn:"Chinese (Simplified)"},{code:"zh-TW",name:"中文 (繁體)",nameEn:"Chinese (Traditional)"},{code:"ko",name:"한국어",nameEn:"Korean"},{code:"es",name:"Español",nameEn:"Spanish"},{code:"fr",name:"Français",nameEn:"French"},{code:"de",name:"Deutsch",nameEn:"German"},{code:"it",name:"Italiano",nameEn:"Italian"},{code:"pt",name:"Português",nameEn:"Portuguese"},{code:"ru",name:"Русский",nameEn:"Russian"},{code:"ar",name:"العربية",nameEn:"Arabic"},{code:"hi",name:"हिन्दी",nameEn:"Hindi"},{code:"th",name:"ไทย",nameEn:"Thai"},{code:"vi",name:"Tiếng Việt",nameEn:"Vietnamese"},{code:"id",name:"Bahasa Indonesia",nameEn:"Indonesian"},{code:"tr",name:"Türkçe",nameEn:"Turkish"},{code:"pl",name:"Polski",nameEn:"Polish"},{code:"nl",name:"Nederlands",nameEn:"Dutch"},{code:"sv",name:"Svenska",nameEn:"Swedish"}].map(e=>[e.code,e]));class c{constructor(){this.floatingElement=null,this.translation=""}show(e,t){this.hide(),this.translation=e,this.floatingElement=this.createFloatingElement();const n=this.createTextElement(e);this.floatingElement.appendChild(n);const a=this.createCopyButton();this.floatingElement.appendChild(a),document.body.appendChild(this.floatingElement),this.positionElement(t),s.log("FloatingUI shown at",t)}hide(){this.floatingElement&&this.floatingElement.parentNode&&(this.floatingElement.parentNode.removeChild(this.floatingElement),this.floatingElement=null,s.log("FloatingUI hidden"))}createCopyButton(){const e=document.createElement("button");return e.className="copy-button",e.textContent="Copy",e.type="button",Object.assign(e.style,{marginTop:"8px",padding:"6px 12px",backgroundColor:"#4F46E5",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"14px",fontWeight:"500"}),e.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(this.translation),e.textContent="Copied!",e.style.backgroundColor="#10B981",setTimeout(()=>{e.textContent="Copy",e.style.backgroundColor="#4F46E5"},2e3),s.log("Translation copied to clipboard")}catch(t){s.error("Failed to copy to clipboard:",t),e.textContent="Error",e.style.backgroundColor="#EF4444",setTimeout(()=>{e.textContent="Copy",e.style.backgroundColor="#4F46E5"},2e3)}}),e}createFloatingElement(){const e=document.createElement("div");e.className="floating-translation";const t=window.matchMedia("(prefers-color-scheme: dark)").matches;return Object.assign(e.style,{position:"fixed",zIndex:"10000",backgroundColor:t?"#1F2937":"#FFFFFF",color:t?"#F3F4F6":"#1F2937",padding:"16px",borderRadius:"8px",boxShadow:"0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)",maxWidth:"400px",minWidth:"200px",display:"flex",flexDirection:"column",border:t?"1px solid #374151":"1px solid #E5E7EB"}),e}createTextElement(e){const t=document.createElement("div");return t.className="translation-text",t.textContent=e,Object.assign(t.style,{fontSize:"14px",lineHeight:"1.5",wordBreak:"break-word",marginBottom:"8px"}),t}positionElement(e){if(!this.floatingElement)return;let{x:t,y:n}=e;t=Math.max(0,t),n=Math.max(0,n),t+=10,n+=10;const a=this.floatingElement.getBoundingClientRect();t+a.width>window.innerWidth&&(t=window.innerWidth-a.width-10),n+a.height>window.innerHeight&&(n=window.innerHeight-a.height-10),t=Math.max(0,t),n=Math.max(0,n),this.floatingElement.style.left=`${t}px`,this.floatingElement.style.top=`${n}px`}}class d{constructor(){this.isTranslated=!1,this.extractedNodes=[],this.domManipulator=new e,this.selectionHandler=new r,this.clipboardHandler=new i,this.mutationObserver=new l,this.floatingUI=new c,this.messageBus=new n,s.log("ContentScript initialized")}initialize(){this.messageBus.listen(this.handleMessage.bind(this)),this.selectionHandler.enable(),s.log("ContentScript ready")}async handleMessage(e,t,n){const o=(new Date).toISOString();console.log(`[Content:ContentScript] ${o} - handleMessage() called:`,{messageType:e.type,payload:"payload"in e?e.payload:void 0}),s.log("ContentScript received message:",e.type);try{switch(e.type){case a.TRANSLATE_PAGE:console.log(`[Content:ContentScript] ${o} - Handling TRANSLATE_PAGE:`,{targetLanguage:"payload"in e?e.payload.targetLanguage:"en"}),await this.translatePage("payload"in e?e.payload.targetLanguage:"en"),console.log(`[Content:ContentScript] ${o} - TRANSLATE_PAGE completed successfully`),n({success:!0});break;case a.TRANSLATE_SELECTION:console.log(`[Content:ContentScript] ${o} - Handling TRANSLATE_SELECTION`),await this.translateSelection("payload"in e?e.payload.targetLanguage:"en"),console.log(`[Content:ContentScript] ${o} - TRANSLATE_SELECTION completed successfully`),n({success:!0});break;case a.TRANSLATE_CLIPBOARD:console.log(`[Content:ContentScript] ${o} - Handling TRANSLATE_CLIPBOARD`),await this.translateClipboard("payload"in e?e.payload.targetLanguage:"en"),console.log(`[Content:ContentScript] ${o} - TRANSLATE_CLIPBOARD completed successfully`),n({success:!0});break;case a.RESET:console.log(`[Content:ContentScript] ${o} - Handling RESET`),this.reset(),console.log(`[Content:ContentScript] ${o} - RESET completed successfully`),n({success:!0});break;default:console.warn(`[Content:ContentScript] ${o} - Unknown message type:`,e.type),s.log("Unknown message type:",e.type),n({success:!1,error:"Unknown message type"})}}catch(e){console.error(`[Content:ContentScript] ${o} - Error handling message:`,{error:e,message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),s.error("Error handling message:",e),n({success:!1,error:String(e)})}}async translatePage(e){const t=(new Date).toISOString();console.log(`[Content:ContentScript] ${t} - translatePage() called:`,{targetLanguage:e});try{if(s.log("Translating page to",e),console.log(`[Content:ContentScript] ${t} - Extracting text nodes from DOM...`),this.extractedNodes=this.domManipulator.extractTextNodes(),console.log(`[Content:ContentScript] ${t} - Text nodes extracted:`,{count:this.extractedNodes.length}),0===this.extractedNodes.length)return console.warn(`[Content:ContentScript] ${t} - No text nodes to translate`),void s.log("No text nodes to translate");const n=this.extractedNodes.map(e=>e.text);console.log(`[Content:ContentScript] ${t} - Prepared texts for translation:`,{count:n.length,firstText:n[0]?.substring(0,50)}),s.log(`Extracted ${n.length} text nodes`),console.log(`[Content:ContentScript] ${t} - Sending REQUEST_TRANSLATION to background:`,{type:a.REQUEST_TRANSLATION,action:"requestTranslation",textsCount:n.length,targetLanguage:e});const o=await this.messageBus.send({type:a.REQUEST_TRANSLATION,action:"requestTranslation",payload:{texts:n,targetLanguage:e}});if(console.log(`[Content:ContentScript] ${t} - Received response from background:`,{response:o,success:o?.success,hasData:!!o?.data,hasTranslations:!!o?.data?.translations}),o?.success&&o?.data?.translations){const e=o.data.translations;console.log(`[Content:ContentScript] ${t} - Applying translations to DOM:`,{translationsCount:e.length,firstTranslation:e[0]?.substring(0,50)}),this.domManipulator.applyTranslations(this.extractedNodes,e),this.isTranslated=!0,console.log(`[Content:ContentScript] ${t} - Page translation completed successfully`),s.log("Page translation completed")}else console.warn(`[Content:ContentScript] ${t} - No translations received in response:`,o),s.warn("No translations received")}catch(e){throw console.error(`[Content:ContentScript] ${t} - Failed to translate page:`,{error:e,message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),s.error("Failed to translate page:",e),e}}async translateSelection(e){try{const t=await this.selectionHandler.translateSelection(e);if(t){const e=window.getSelection();if(e&&e.rangeCount>0){const n=e.getRangeAt(0).getBoundingClientRect();this.floatingUI.show(t,{x:n.left+window.scrollX,y:n.bottom+window.scrollY}),s.log("Selection translation displayed")}}else s.log("No selection to translate")}catch(e){throw s.error("Failed to translate selection:",e),e}}async translateClipboard(e){try{const t=await this.clipboardHandler.translateClipboard(e);t?(this.floatingUI.show(t,{x:window.innerWidth/2-200,y:window.innerHeight/2-100}),s.log("Clipboard translation displayed")):s.log("No clipboard content to translate")}catch(e){throw s.error("Failed to translate clipboard:",e),e}}reset(){try{this.domManipulator.reset(),this.floatingUI.hide(),this.isTranslated=!1,s.log("Page reset to original state")}catch(e){throw s.error("Failed to reset page:",e),e}}enableDynamicTranslation(e){this.mutationObserver.observe(async t=>{t.some(e=>Array.from(e.addedNodes).some(e=>e.nodeType===Node.TEXT_NODE))&&this.isTranslated&&(s.log("Dynamic content detected, re-translating"),await this.translatePage(e))}),s.log("Dynamic translation enabled")}disableDynamicTranslation(){this.mutationObserver.disconnect(),s.log("Dynamic translation disabled")}cleanup(){this.selectionHandler.disable(),this.mutationObserver.disconnect(),this.floatingUI.hide(),s.log("ContentScript cleaned up")}}"undefined"!=typeof chrome&&chrome.runtime?chrome:window.browser;let g=null;try{g=new d,g.initialize(),s.log("DoganayLab Translate - Content Script initialized")}catch(e){s.error("Failed to initialize content script:",e)}window.addEventListener("beforeunload",()=>{g&&g.cleanup()})})();