# 翻訳速度改善とドキュメント整備

## 概要
- OpenRouter API移行は完了
- 現在のブランチ: `mod/rendering-performance`
- 残タスク: 翻訳速度改善とドキュメント整備

## process20 翻訳速度改善

### 背景と目的
- **現状の課題**:
  - ページ全体翻訳に時間がかかり、ユーザー体感速度が遅い
  - ビューポート外のテキストも同時に処理するため、表示領域の翻訳完了が遅延
  - 固定の1秒sleep、並列数10の制約によりAPI効率が低い
- **目的**:
  - ビューポート内のテキストを最優先で翻訳し、体感速度を向上
  - 並列処理とAPI呼び出しを最適化し、全体の翻訳時間を短縮
  - プログレス表示によりUXを改善

### sub2 ビューポート優先翻訳の実装
@target: content.js
@ref: content.js:578-589 `isInViewport()`関数
- [ ] `translatePage()`関数の改修
  - ビューポート内/外でバッチを分離
  - ビューポート内を優先的に翻訳完了
  - ビューポート内完了時に通知表示
- [ ] `createBatches()`関数の改修
  - 優先度別のバッチ生成ロジック追加
  - ビューポート内バッチを先頭に配置
- [ ] 新関数 `translateViewportFirst()`の追加
  - ビューポート内テキストのみを先行翻訳
  - 完了後にビューポート外を翻訳開始

### sub3 並列処理の最適化
@target: content.js
- [ ] 並列数の調整
  - `CONCURRENCY_LIMIT`: 10 → 15 に増加
  - API制限が中程度のため、安全マージンを確保
- [ ] sleep時間の削減
  - チャンク間sleep: 1000ms → 500ms に短縮（content.js:370付近）
  - 特殊要素翻訳: 500ms → 300ms に短縮（content.js:528付近）
  - 動的コンテンツ: 500ms → 300ms に短縮（content.js:845付近）
- [ ] バッチサイズの動的調整
  - 現在の固定800文字を見直し
  - API応答時間に基づく動的調整ロジック追加
- [ ] エラーハンドリングの強化
  - 自動リトライ機能（最大2回）
  - エラー発生時の継続処理

### sub4 プログレス表示の実装
@target: content.js
- [ ] 新関数 `createProgressBar()`
  - 画面上部固定のプログレスバーUI生成
  - ダークモード対応
  - 「ビューポート内」と「全体」の2段階進捗表示
- [ ] 新関数 `updateProgress()`
  - 翻訳進捗の%計算と表示更新
  - マイルストーン表示（ビューポート内完了）
  - 完了時の自動非表示（2秒フェードアウト）
- [ ] `translatePage()`への統合
  - プログレスバーの初期化
  - 各バッチ完了時の進捗更新
  - エラー時のプログレス表示更新

### 期待される効果
- **体感速度**: ビューポート内翻訳が現在の約40-50%の時間で完了
- **全体速度**: 並列処理最適化により全翻訳時間が約20-30%短縮
- **UX**: プログレス表示により待ち時間のストレス軽減

## process50 フォローアップ

### sub1 ドキュメント更新
- [ ] README.mdの更新
  - OpenRouter API使用に関する説明
  - 推奨モデルの記載
  - APIキー取得方法へのリンク
  - 翻訳速度改善に関する説明

## process100 リファクタリング
- [ ] コードの整理
  - 不要なコメントの削除
  - 一貫性のあるコーディングスタイルの確保
- [ ] エラーハンドリングの統一
  - OpenRouter APIのエラーを一元管理

## process200 ドキュメンテーション
- [ ] CHANGELOG.mdの作成/更新
  - v2.0.0: Gemini API → OpenRouter API移行
  - モデル選択機能の追加
  - プロバイダールーティング機能の追加
  - 翻訳速度改善機能の追加
- [ ] CLAUDE.mdの更新
  - OpenRouter API統合に関する情報を追加
